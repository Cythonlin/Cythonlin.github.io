<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RS =&gt; æ¨èç³»ç»Ÿï¼ˆäº”ï¼‰å®æ—¶æ¨è+ABTest+æ¨èä¸­å¿ƒ | Cython_lin</title>
<meta name="description" content="" />
<link rel="shortcut icon" href="https://cythonlin.github.io/favicon.ico">
<link rel="stylesheet" href="https://cythonlin.github.io/styles/main.css">

<script src="https://cythonlin.github.io/media/js/jquery.min.js"></script>
<script src="https://cythonlin.github.io/media/js/masonry.pkgd.min.js"></script>
<script src="https://cythonlin.github.io/media/js/aos.js"></script>
<script src="https://cythonlin.github.io/media/js/pace.min.js"></script>
<script src="https://cythonlin.github.io/media/js/view-image.min.js"></script>
<script src="https://cythonlin.github.io/media/js/jquery.magnific-popup.min.js"></script>
<script src="https://cythonlin.github.io/media/js/functions.js"></script>
    <meta name="referrer" content="never">
    <meta name="description" content="ä¸šåŠ¡æµç¨‹

åç«¯å‘é€æ¨èè¯·æ±‚ï¼Œå®æ—¶æ¨èç³»ç»Ÿæ‹¿åˆ°è¯·æ±‚å‚æ•°

grpcå¯¹æ¥


å¯¹ç”¨æˆ·åšABTeståˆ†æµ

ABTestå®éªŒä¸­å¿ƒï¼Œç”¨äºè¿›è¡Œåˆ†æµä»»åŠ¡ï¼Œæ–¹ä¾¿æµ‹è¯•è°ƒæ•´ä¸åŒçš„æ¨¡å‹ä¸Šçº¿


æ¨èä¸­å¿ƒæœåŠ¡

æ ¹æ®ç”¨æˆ·åœ¨ABTeståˆ†é…çš„ä¸åŒçš„ç®—æ³•è¿›è¡Œå¬å›æœ..." />
    <meta name="keywords" content="RS" />
    <script src="https://cythonlin.github.io/media/js/waterfall.min.js"></script>
    <script src="https://cythonlin.github.io/media/js/prism.min.js"></script>
  </head>
  <body>
            <header id="header" class="grid-container">
        <!-- start: .menu-wrapper -->
        <div class="menu-mobile"> 
          <i class="fa fa-reorder"></i>
        </div>
        <div class="menu-wrapper">
          <div class="">
            <div class="logo">
              <a href="https://cythonlin.github.io"><img src="\media\images\custom-headerLogo.png" alt=""></a>
            </div>
            <!-- start: .main-nav -->

            <nav class="main-nav grid-container grid-parent">
              <ul id="menu-header" class="menu gradient-effect">
                <li class=""><a href="https://cythonlin.github.io" class="menu">é¦–é¡µ</a></li>
                
                  <li class="" >
                    <a href="/archives" class="menu">
                      å½’æ¡£
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/tags" class="menu">
                      æ ‡ç­¾
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="https://cythonlin.github.io/post/the-future-is-promising" class="menu">
                      å…³äº
                    </a>
                  </li>
                
                <li class="search-menu-item hide-on-mobile hide-on-tablet"><a href="#search-lightbox" class="lightbox mfp-inline"><i class="fa fa-search-line"></i></a></li>
              </ul>
            </nav>
            <a href="#search-lightbox" class="lightbox epcl-search-button mfp-inline hide-on-tablet hide-on-desktop"><i class="fa fa-search-line"></i></a>
            <!-- end: .main-nav -->
            <div class="clear"></div>
            <div class="border hide-on-tablet hide-on-mobile"></div>
          </div>    
          <div class="clear"></div>
        </div>
        <!-- end: .menu-wrapper -->
        <div class="clear"></div>
      </header>
      <div class="hide-on-mobile hide-on-tablet hide-on-desktop">
        <div id="search-lightbox" class="grid-container grid-small grid-parent mfp-hide">
          <div class="search-wrapper section">
            <form id="gridea-search-form" data-update="1615464813020" action="/search/index.html" class="search-form" _lpchecked="1">
              <input type="text" name="q" id="s" value="" class="search-field" placeholder="æœç‚¹å•¥..." aria-label="æœç‚¹å•¥..." required="">
              <button type="submit" class="submit" aria-label="Submit">
                <i class="fa fa-search-line"></i>
              </button>
            </form>
          </div>
        </div>
      </div>

      <main id="single" class="main grid-container fullcover no-sidebar aos-init aos-animate" data-aos="fade">

        <div class="center content">
          <div class="featured-image cover" style="background-image: url('/media/images/gridea.jpg');">
            <div class="meta top"> 
              <time class="meta-info" style="float:left;" datetime="2021-02-22"><i class="fa fa-calendar"></i><span class="lately">17 å¤©å‰</span></time>
              
              <a href="https://cythonlin.github.io/post/ide-greater-cheatsh/#comments" class="comments meta-info" title="">
                <i class="fa fa-comment remixicon"></i><span class="comment-count valine-comment-count" data-xid="/ide-greater-cheatsh/"> </span>
              </a>
              <span id="/ide-greater-cheatsh/" class="leancloud_visitors views-counter meta-info" title=""><i class="fa fa-leancloud remixicon"></i><span class="leancloud-visitors-count"></span></span>
              
            </div>
            <div class="info">
              <div class="tags ">
                
                      <a href="https://cythonlin.github.io/tag/EjFvvnhFs/" class="ctag ctag-0 ctag-EjFvvnhFs" aria-label="">RS</a>
                    
              </div>
              <h1 class="title ularge white bold">RS =&gt; æ¨èç³»ç»Ÿï¼ˆäº”ï¼‰å®æ—¶æ¨è+ABTest+æ¨èä¸­å¿ƒ</h1>
            </div>
          </div>
        </div>  

        <div class="epcl-page-wrapper">
          <div class="left-content grid-70 np-mobile">
            <article class="main-article post">
              <section class="post-content">
                <div class="text">
                  <h1 id="ä¸šåŠ¡æµç¨‹">ä¸šåŠ¡æµç¨‹</h1>
<ul>
<li>åç«¯å‘é€æ¨èè¯·æ±‚ï¼Œå®æ—¶æ¨èç³»ç»Ÿæ‹¿åˆ°è¯·æ±‚å‚æ•°
<ul>
<li>grpcå¯¹æ¥</li>
</ul>
</li>
<li>å¯¹ç”¨æˆ·åšABTeståˆ†æµ
<ul>
<li>ABTestå®éªŒä¸­å¿ƒï¼Œç”¨äºè¿›è¡Œåˆ†æµä»»åŠ¡ï¼Œæ–¹ä¾¿æµ‹è¯•è°ƒæ•´ä¸åŒçš„æ¨¡å‹ä¸Šçº¿</li>
</ul>
</li>
<li>æ¨èä¸­å¿ƒæœåŠ¡
<ul>
<li>æ ¹æ®ç”¨æˆ·åœ¨ABTeståˆ†é…çš„ä¸åŒçš„ç®—æ³•è¿›è¡Œå¬å›æœåŠ¡å’Œæ’åºæœåŠ¡è¯»å–è¿”å›ç»“æœ</li>
</ul>
</li>
<li>è¿”å›æ¨èç»“æœå’ŒåŸ‹ç‚¹å‚æ•°å°è£…</li>
</ul>
<h1 id="grpcæ¥å£å¯¹æ¥ä»‹ç»">grpcæ¥å£å¯¹æ¥ä»‹ç»</h1>
<h2 id="æ¨èæ¥å£å¯¹æ¥">æ¨èæ¥å£å¯¹æ¥</h2>
<p>è¯·æ±‚å‚æ•°ï¼š</p>
<ul>
<li>feedæµæ¨èï¼š
<ul>
<li>ç”¨æˆ·ID</li>
<li>é¢‘é“ID</li>
<li>æ¨èæ–‡ç« æ•°é‡</li>
<li>è¯·æ±‚æ¨èæ—¶é—´æˆ³</li>
</ul>
</li>
<li>ç›¸ä¼¼æ–‡ç« è·å–ï¼šæ–‡ç« IDï¼Œæ¨èæ–‡ç« æ•°é‡
<ul>
<li>æ–‡ç« ID</li>
<li>æ¨èæ–‡ç« æ•°é‡ï¼ˆçŒœä½ å–œæ¬¢ï¼Œéä¸»æ¨èï¼‰</li>
</ul>
</li>
</ul>
<p>è¿”å›å‚æ•°ï¼š</p>
<ul>
<li>
<p>feedæµæ¨èï¼šæ›å…‰å‚æ•°ï¼Œæ¯ç¯‡æ–‡ç« çš„æ‰€æœ‰è¡Œä¸ºå‚æ•°ï¼Œä¸Šä¸€æ¡æ—¶é—´æˆ³</p>
<pre><code>  # åŸ‹ç‚¹å‚æ•°å‚è€ƒï¼š
  # {
  #     &quot;param&quot;: '{&quot;action&quot;: &quot;exposure&quot;, &quot;userId&quot;: 1, &quot;articleId&quot;: [1,2,3,4],  &quot;algorithmCombine&quot;: &quot;c1&quot;}',
  #     &quot;recommends&quot;: [
  #         {&quot;article_id&quot;: 1, &quot;param&quot;: {&quot;click&quot;: &quot;{&quot;action&quot;: &quot;click&quot;, &quot;userId&quot;: &quot;1&quot;, &quot;articleId&quot;: 1, &quot;algorithmCombine&quot;: 'c1'}&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;,&quot;read&quot;:&quot;&quot;}},
  #         {&quot;article_id&quot;: 2, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, &quot;read&quot;:&quot;&quot;}},
  #         {&quot;article_id&quot;: 3, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, &quot;read&quot;:&quot;&quot;}},
  #         {&quot;article_id&quot;: 4, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, &quot;read&quot;:&quot;&quot;}}
  #     ]
  #     &quot;timestamp&quot;: 1546391572
  # }
</code></pre>
</li>
</ul>
<h2 id="å¯¹æ¥é€šä¿¡æ–¹å¼-grpc">å¯¹æ¥é€šä¿¡æ–¹å¼-GRPC</h2>
<p>GRPCä¼˜ç‚¹ï¼š</p>
<ul>
<li>gRPCæ˜¯ç”±Googleå…¬å¸å¼€æºçš„é«˜æ€§èƒ½RPCæ¡†æ¶ã€‚</li>
<li>gRPCæ”¯æŒå¤šè¯­è¨€</li>
<li>gRPCåŸç”Ÿä½¿ç”¨Cã€Javaã€Goè¿›è¡Œäº†ä¸‰ç§å®ç°ï¼Œè€ŒCè¯­è¨€å®ç°çš„ç‰ˆæœ¬è¿›è¡Œå°è£…ååˆæ”¯æŒC++ã€C#ã€Nodeã€ObjCã€ Pythonã€Rubyã€PHPç­‰å¼€å‘è¯­è¨€</li>
<li>gRPCæ”¯æŒå¤šå¹³å°</li>
<li>æ”¯æŒçš„å¹³å°åŒ…æ‹¬ï¼šLinuxã€Androidã€iOSã€MacOSã€Windows</li>
<li>gRPCçš„æ¶ˆæ¯åè®®ä½¿ç”¨Googleè‡ªå®¶å¼€æºçš„Protocol Buffersåè®®æœºåˆ¶ï¼ˆproto3ï¼‰ åºåˆ—åŒ–</li>
<li>gRPCçš„ä¼ è¾“ä½¿ç”¨HTTP/2æ ‡å‡†ï¼Œæ”¯æŒåŒå‘æµå’Œè¿æ¥å¤šè·¯å¤ç”¨</li>
</ul>
<h2 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h2>
<ul>
<li>ä½¿ç”¨Protocol Buffersï¼ˆproto3ï¼‰çš„IDLæ¥å£å®šä¹‰è¯­è¨€å®šä¹‰æ¥å£æœåŠ¡ï¼Œç¼–å†™åœ¨æ–‡æœ¬æ–‡ä»¶ï¼ˆä»¥.protoä¸ºåç¼€åï¼‰ä¸­ã€‚</li>
<li>ä½¿ç”¨protobufç¼–è¯‘å™¨ç”ŸæˆæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä½¿ç”¨çš„stubä»£ç </li>
</ul>
<h2 id="ä»£ç ç»“æ„">ä»£ç ç»“æ„</h2>
<ul>
<li>
<p>æ–‡ä»¶ååç¼€: .proto</p>
</li>
<li>
<p>ç‰ˆæœ¬å£°æ˜ï¼šProtocol Buffersæ–‡æ¡£çš„ç¬¬ä¸€è¡Œéæ³¨é‡Šè¡Œï¼Œä¸ºç‰ˆæœ¬ç”³æ˜ï¼Œä¸å¡«å†™çš„è¯é»˜è®¤ä¸ºç‰ˆæœ¬2ã€‚</p>
<pre><code>  syntax = &quot;proto3&quot;;
  æˆ–è€…
  syntax = &quot;proto2&quot;;
</code></pre>
</li>
<li>
<p>æ¶ˆæ¯ç±»å‹ï¼šProtocol Buffersä½¿ç”¨messageå®šä¹‰æ¶ˆæ¯æ•°æ®ã€‚åœ¨Protocol Buffersä¸­ä½¿ç”¨çš„æ•°æ®éƒ½æ˜¯é€šè¿‡messageæ¶ˆæ¯æ•°æ®å°è£…åŸºæœ¬ç±»å‹æ•°æ®æˆ–å…¶ä»–æ¶ˆæ¯æ•°æ®ï¼Œå¯¹åº”Pythonä¸­çš„ç±»ã€‚</p>
<pre><code>  message SearchRequest {
      string query = 1;
      int32 page_number = 2;
      int32 result_per_page = 3;
  }
  # string: æ•°æ®ç±»å‹
  # query: æ•°æ®åˆ«å
  # 1: å­—æ®µç¼–å·
</code></pre>
</li>
<li>
<p>å­—æ®µç¼–å·ï¼šåœ¨ä½¿ç”¨æ¶ˆæ¯ç±»å‹åä¸åº”æ›´æ”¹ã€‚ è¯·æ³¨æ„ï¼Œ1åˆ°15èŒƒå›´å†…çš„å­—æ®µç¼–å·éœ€è¦ä¸€ä¸ªå­—èŠ‚è¿›è¡Œç¼–ç ï¼ŒåŒ…æ‹¬å­—æ®µç¼–å·å’Œå­—æ®µç±»å‹ã€‚16åˆ°2047èŒƒå›´å†…çš„å­—æ®µç¼–å·å ç”¨ä¸¤ä¸ªå­—èŠ‚</p>
<pre><code>  # singularï¼šæ ¼å¼è‰¯å¥½çš„æ¶ˆæ¯å¯ä»¥åŒ…å«è¯¥å­—æ®µä¸­çš„é›¶ä¸ªæˆ–ä¸€ä¸ªï¼ˆä½†ä¸è¶…è¿‡ä¸€ä¸ªï¼‰ã€‚

  # repeatedï¼šæ­¤å­—æ®µå¯ä»¥åœ¨æ ¼å¼è‰¯å¥½çš„æ¶ˆæ¯ä¸­é‡å¤ä»»æ„æ¬¡æ•°ï¼ˆåŒ…æ‹¬é›¶ï¼‰ã€‚å°†ä¿ç•™é‡å¤å€¼çš„é¡ºåºã€‚å¯¹åº”Pythonçš„åˆ—è¡¨
  message Result {
      string url = 1;
      string title = 2;
      repeated string snippets = 3;
  }
</code></pre>
</li>
<li>
<p>å®‰è£…protobufç¼–è¯‘å™¨å’Œgrpcåº“</p>
<pre><code>  pip install grpcio-tools
</code></pre>
</li>
<li>
<p>ç¼–è¯‘ç”Ÿæˆä»£ç </p>
<pre><code>  python -m grpc_tools.protoc -I. --python_out=.. --grpc_python_out=.. itcast.proto
</code></pre>
<ul>
<li>-Iè¡¨ç¤ºæœç´¢protoæ–‡ä»¶ä¸­è¢«å¯¼å…¥æ–‡ä»¶çš„ç›®å½•</li>
<li>--python_outè¡¨ç¤ºä¿å­˜ç”ŸæˆPythonæ–‡ä»¶çš„ç›®å½•ï¼Œç”Ÿæˆçš„æ–‡ä»¶ä¸­åŒ…å«æ¥å£å®šä¹‰ä¸­çš„æ•°æ®ç±»å‹</li>
<li>--grpc_python_outè¡¨ç¤ºä¿å­˜ç”ŸæˆPythonæ–‡ä»¶çš„ç›®å½•ï¼Œç”Ÿæˆçš„æ–‡ä»¶ä¸­åŒ…å«æ¥å£å®šä¹‰ä¸­çš„æœåŠ¡ç±»å‹</li>
</ul>
</li>
</ul>
<h1 id="æ¨èæ¥å£protocoåè®®å®šä¹‰å®ä¾‹">æ¨èæ¥å£protocoåè®®å®šä¹‰å®ä¾‹</h1>
<h3 id="åˆ›å»ºabtestç›®å½•å°†ç›¸å…³æ¥å£ä»£ç æ”¾å…¥user_recoprotoåè®®æ–‡ä»¶">åˆ›å»ºabtestç›®å½•ï¼Œå°†ç›¸å…³æ¥å£ä»£ç æ”¾å…¥user_reco.protoåè®®æ–‡ä»¶</h3>
<ul>
<li>ç”¨æˆ·åˆ·æ–°feedæµæ¥å£
<ul>
<li>user_recommend(User) returns (Track)</li>
</ul>
</li>
<li>æ–‡ç« ç›¸ä¼¼(çŒœä½ å–œæ¬¢)æ¥å£
<ul>
<li>
<p>article_recommend(Article) returns(Similar)</p>
<pre><code>  syntax = &quot;proto3&quot;;

  message User {

      string user_id = 1;
      int32 channel_id = 2;
      int32 article_num = 3;
      int64 time_stamp = 4;
  }
  // int32 ---&gt; int64 article_id
  message Article {

      int64 article_id = 1;
      int32 article_num = 2;

  }

  message param2 {
      string click = 1;
      string collect = 2;
      string share = 3;
      string read = 4;
  }

  message param1 {
      int64 article_id = 1;
      param2 params = 2;
  }

  message Track {
      string exposure = 1;
      repeated param1 recommends = 2;
      int64 time_stamp = 3;
  }

  message Similar {
      repeated int64 article_id = 1;
  }

  service UserRecommend {
      // feed recommend
      rpc user_recommend(User) returns (Track) {}
      rpc article_recommend(Article) returns(Similar) {}
  }
</code></pre>
</li>
</ul>
</li>
</ul>
<p>é€šè¿‡å‘½ä»¤ç”Ÿæˆ2ä¸ªpyæ–‡ä»¶ï¼ˆå®¢æˆ·ç«¯ï¼ŒæœåŠ¡ç«¯ï¼‰</p>
<pre><code>python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=.  user_reco.proto
</code></pre>
<p>ğŸ‘ä¸€ä¸ªæ–‡ä»¶åå«åšï¼šuser_reco_pb2.py  ï¼ˆä¸»è¦åŠŸèƒ½æ˜¯å®šä¹‰æ¶ˆæ¯ä½“ï¼‰<br>
ğŸ‘å¦ä¸€ä¸ªæ–‡ä»¶åå«åšï¼šuser_reco_pb2_grpc.pyï¼ˆåŠŸèƒ½æ˜¯å®šä¹‰æœåŠ¡ï¼Œè¿”å›ä¸Šé¢çš„æ¶ˆæ¯ä½“ï¼‰</p>
<h1 id="grpcæœåŠ¡ç¼–å†™æœåŠ¡å™¨ç«¯">GrpcæœåŠ¡ç¼–å†™ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰</h1>
<p>åˆ›å»ºrouting.pyæ–‡ä»¶ï¼Œå†™å…¥æœåŠ¡ç«¯ä»£ç ï¼š</p>
<pre><code>import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(BASE_DIR))
from concurrent import futures
from abtest import user_reco_pb2
from abtest import user_reco_pb2_grpc
from setting.default import DefaultConfig
import grpc
import time
import json
</code></pre>
<p>éœ€è¦æ·»åŠ grpcæœåŠ¡é…ç½®ï¼š</p>
<pre><code># rpc
RPC_SERVER = '192.168.19.137:9999'
</code></pre>
<p>å®Œæ•´ä»£ç (ç›¸å½“äºdjangoå’Œflaskçš„ç±»è§†å›¾)ï¼š</p>
<pre><code># åŸºäºç”¨æˆ·æ¨èçš„rpcæœåŠ¡æ¨è
# å®šä¹‰æŒ‡å®šçš„rpcæœåŠ¡è¾“å…¥è¾“å‡ºå‚æ•°æ ¼å¼proto
class UserRecommendServicer(user_reco_pb2_grpc.UserRecommendServicer):
    &quot;&quot;&quot;
    å¯¹ç”¨æˆ·è¿›è¡ŒæŠ€æœ¯æ–‡ç« æ¨è
    &quot;&quot;&quot;
    # è¿™ä¸ªæ–¹æ³•å°±æ˜¯ GRPCç”Ÿæˆçš„ï¼Œå¤å†™å³å¯
    def user_recommend(self, request, context):
        &quot;&quot;&quot;
        ç”¨æˆ·feedæµæ¨è
        :param request:
        :param context:
        :return:
        &quot;&quot;&quot;
        # é€‰æ‹©C4ç»„åˆ
        user_id = request.user_id
        channel_id = request.channel_id
        article_num = request.article_num
        time_stamp = request.time_stamp

        # è§£æå‚æ•°ï¼Œå¹¶è¿›è¡Œæ¨èä¸­å¿ƒæ¨è(æš‚æ—¶ä½¿ç”¨å‡æ•°æ®æ›¿ä»£)
        class Temp(object):
            user_id = -10
            algo = 'test'
            time_stamp = -10

        tp = Temp()
        tp.user_id = user_id
        tp.time_stamp = time_stamp
        _track = add_track([], tp)

        # è§£æè¿”å›å‚æ•°åˆ°rpcç»“æœå‚æ•°
        # å‚æ•°å¦‚ä¸‹
        # [       {&quot;article_id&quot;: 1, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, 'detentionTime':''}},
        #         {&quot;article_id&quot;: 2, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, 'detentionTime':''}},
        #         {&quot;article_id&quot;: 3, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, 'detentionTime':''}},
        #         {&quot;article_id&quot;: 4, &quot;param&quot;: {&quot;click&quot;: &quot;&quot;, &quot;collect&quot;: &quot;&quot;, &quot;share&quot;: &quot;&quot;, 'detentionTime':''}}
        #     ]
        # ç¬¬äºŒä¸ªrpcå‚æ•°
        _param1 = []
        for _ in _track['recommends']:
            # paramçš„å°è£…
            _params = user_reco_pb2.param2(click=_['param']['click'],
                                        collect=_['param']['collect'],
                                        share=_['param']['share'],
                                        read=_['param']['read'])
            _p2 = user_reco_pb2.param1(article_id=_['article_id'], params=_params)
            _param1.append(_p2)
        # param
        return user_reco_pb2.Track(exposure=_track['param'], recommends=_param1, time_stamp=_track['timestamp'])

#    def article_recommend(self, request, context):
#        &quot;&quot;&quot;
#       æ–‡ç« ç›¸ä¼¼æ¨è
#       :param request:
#       :param context:
#       :return:
#       &quot;&quot;&quot;
#       # è·å–webå‚æ•°
#       article_id = request.article_id
#       article_num = request.article_num
#
#        # è¿›è¡Œæ–‡ç« ç›¸ä¼¼æ¨è,è°ƒç”¨æ¨èä¸­å¿ƒçš„æ–‡ç« ç›¸ä¼¼
#       _article_list = article_reco_list(article_id, article_num, 105)
#
#       # rpcå‚æ•°å°è£…
#       return user_reco_pb2.Similar(article_id=_article_list)


def serve():

    # å¤šçº¿ç¨‹æœåŠ¡å™¨
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))

    # æ³¨å†Œæœ¬åœ°æœåŠ¡ï¼ˆserveré‡Œé¢åªä¿®æ”¹æ­¤ç±»å³å¯UserRecommendServicerï¼‰
    # æ­¤ç±»æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ï¼Œå¹¶ä¸”ç»§æ‰¿è‡ªï¼Œ ç”¨ grpcå‘½ä»¤è¡Œç”Ÿæˆçš„æ–‡ä»¶é‡Œçš„ç±»
    user_reco_pb2_grpc.add_UserRecommendServicer_to_server(UserRecommendServicer(), server)
    # ç›‘å¬ç«¯å£
    server.add_insecure_port(DefaultConfig.RPC_SERVER)

    # å¼€å§‹æ¥æ”¶è¯·æ±‚è¿›è¡ŒæœåŠ¡
    server.start()
    # ä½¿ç”¨ ctrl+c å¯ä»¥é€€å‡ºæœåŠ¡
    _ONE_DAY_IN_SECONDS = 60 * 60 * 24
    try:
        while True:
            time.sleep(_ONE_DAY_IN_SECONDS)
    except KeyboardInterrupt:
        server.stop(0)


if __name__ == '__main__':
    # æµ‹è¯•grpcæœåŠ¡
    serve()
</code></pre>
<p>åŸ‹ç‚¹å‚æ•°çš„æ¥å£å°è£…ï¼š</p>
<pre><code>class Temp(object):
    user_id = '1115629498121846784'
    algo = 'test'
    time_stamp = int(time.time() * 1000)
_track = add_track([], Temp())
</code></pre>
<p>webåå°è¯·æ±‚ä¼ å…¥çš„æ—¶é—´æˆ³æ˜¯time.time(),Out[3]: int(1558128143.8735564) * 1000çš„å¤§å°</p>
<pre><code>def add_track(res, temp):
    &quot;&quot;&quot;
    å°è£…åŸ‹ç‚¹å‚æ•°
    :param res: æ¨èæ–‡ç« idåˆ—è¡¨
    :param cb: åˆå¹¶å‚æ•°
    :param rpc_param: rpcå‚æ•°
    :return: åŸ‹ç‚¹å‚æ•°
        æ–‡ç« åˆ—è¡¨å‚æ•°
        å•æ–‡ç« å‚æ•°
    &quot;&quot;&quot;
    # æ·»åŠ åŸ‹ç‚¹å‚æ•°
    track = {}

    # å‡†å¤‡æ›å…‰å‚æ•°
    # å…¨éƒ¨å­—ç¬¦ä¸²å½¢å¼æä¾›ï¼Œåœ¨hiveç«¯ä¸ä¼šè§£æé—®é¢˜
    _exposure = {&quot;action&quot;: &quot;exposure&quot;, &quot;userId&quot;: temp.user_id, &quot;articleId&quot;: json.dumps(res),
                &quot;algorithmCombine&quot;: temp.algo}

    track['param'] = json.dumps(_exposure)
    track['recommends'] = []

    # å‡†å¤‡å…¶å®ƒç‚¹å‡»å‚æ•°
    for _id in res:
        # æ„é€ å­—å…¸
        _dic = {}
        _dic['article_id'] = _id
        _dic['param'] = {}

        # å‡†å¤‡clickå‚æ•°
        _p = {&quot;action&quot;: &quot;click&quot;, &quot;userId&quot;: temp.user_id, &quot;articleId&quot;: str(_id),
            &quot;algorithmCombine&quot;: temp.algo}

        _dic['param']['click'] = json.dumps(_p)
        # å‡†å¤‡collectå‚æ•°
        _p[&quot;action&quot;] = 'collect'
        _dic['param']['collect'] = json.dumps(_p)
        # å‡†å¤‡shareå‚æ•°
        _p[&quot;action&quot;] = 'share'
        _dic['param']['share'] = json.dumps(_p)
        # å‡†å¤‡detentionTimeå‚æ•°
        _p[&quot;action&quot;] = 'read'
        _dic['param']['read'] = json.dumps(_p)

        track['recommends'].append(_dic)

    track['timestamp'] = temp.time_stamp
    return track
</code></pre>
<h1 id="å®¢æˆ·ç«¯æµ‹è¯•ä»£ç ">å®¢æˆ·ç«¯æµ‹è¯•ä»£ç </h1>
<p>æµ‹è¯•å®¢æˆ·ç«¯</p>
<pre><code>import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(BASE_DIR))
from abtest import user_reco_pb2_grpc
from abtest import user_reco_pb2
import grpc
from setting.default import DefaultConfig
import time


def test():
    article_dict = {}
    # æ„é€ ä¼ å…¥æ•°æ®

    req_article = user_reco_pb2.User()
    req_article.user_id = '1115629498121846784'
    req_article.channel_id = 18
    req_article.article_num = 10
    req_article.time_stamp = int(time.time() * 1000)
    # req_article.time_stamp = 1555573069870

    with grpc.insecure_channel(DefaultConfig.RPC_SERVER) as rpc_cli:
        print('''''')
        try:
            stub = user_reco_pb2_grpc.UserRecommendStub(rpc_cli)
            resp = stub.user_recommend(req_article)
        except Exception as e:
            print(e)
            article_dict['param'] = []
        else:

            # è§£æè¿”å›ç»“æœå‚æ•°
            article_dict['exposure_param'] = resp.exposure

            reco_arts = resp.recommends

            reco_art_param = []
            reco_list = []
            for art in reco_arts:
                reco_art_param.append({
                    'artcle_id': art.article_id,
                    'params': {
                        'click': art.params.click,
                        'collect': art.params.collect,
                        'share': art.params.share,
                        'read': art.params.read
                    }
                })

                reco_list.append(art.article_id)
            article_dict['param'] = reco_art_param

            # æ–‡ç« åˆ—è¡¨ä»¥åŠå‚æ•°ï¼ˆæ›å…‰å‚æ•° ä»¥åŠ æ¯ç¯‡æ–‡ç« çš„ç‚¹å‡»ç­‰å‚æ•°ï¼‰
            print(reco_list, article_dict)

if __name__ == '__main__':
    test()
</code></pre>
<h1 id="abtest">ABtest</h1>
<p>ABtestæœ‰å‡ ä¸ªé‡è¦çš„åŠŸèƒ½:</p>
<ul>
<li>ä¸€ä¸ªæ˜¯ABTestå®æ—¶åˆ†æµæœåŠ¡ï¼Œæ ¹æ®ç”¨æˆ·è®¾å¤‡ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯è¿›è¡Œabåˆ†æµã€‚</li>
<li>å®æ—¶æ•ˆæœåˆ†æç»Ÿè®¡ï¼Œå°†åˆ†æµåç¨‹åºç‚¹å‡»ã€æµè§ˆç­‰é€šè¿‡hiveã€hadoopç¨‹åºç»Ÿè®¡åï¼Œåœ¨ç»Ÿè®¡å¹³å°ä¸Šè¿›è¡Œå±•ç¤ºã€‚</li>
<li>ç”¨å›¾è¡¨æ•°æ®åˆ†æç”¨æˆ·æ´»è·ƒåº¦ã€ç‚¹å‡»ç‡</li>
</ul>
<h2 id="æµé‡åˆ‡åˆ†å‚æ•°é…ç½®">æµé‡åˆ‡åˆ†å‚æ•°é…ç½®</h2>
<p>A/Bæµ‹è¯•çš„æµé‡åˆ‡åˆ†æ˜¯åœ¨Rank Serverç«¯å®Œæˆçš„ã€‚æˆ‘ä»¬æ ¹æ®ç”¨æˆ·IDå°†æµé‡åˆ‡åˆ†ä¸ºå¤šä¸ªæ¡¶ï¼ˆBucketï¼‰ï¼Œæ¯ä¸ªæ¡¶å¯¹åº”ä¸€ç§æ’åºç­–ç•¥ï¼Œæ¡¶å†…æµé‡å°†ä½¿ç”¨ç›¸åº”çš„ç­–ç•¥è¿›è¡Œæ’åºã€‚ä½¿ç”¨IDè¿›è¡Œæµé‡åˆ‡åˆ†ï¼Œæ˜¯ä¸ºäº†ä¿è¯ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ã€‚</p>
<pre><code>from collections import namedtuple

# abtestå‚æ•°ä¿¡æ¯
# ABTestå‚æ•°
param = namedtuple('RecommendAlgorithm', ['COMBINE',
                                        'RECALL',
                                        'SORT',
                                        'CHANNEL',
                                        'BYPASS']
                )

RAParam = param(
    COMBINE={
        'Algo-1': (1, [100, 101, 102, 103, 104], []),  # é¦–é¡µæ¨èï¼Œæ‰€æœ‰å¬å›ç»“æœè¯»å–+LRæ’åº
        'Algo-2': (2, [100, 101, 102, 103, 104], [])  # é¦–é¡µæ¨èï¼Œæ‰€æœ‰å¬å›ç»“æœè¯»å– æ’åº
    },
    RECALL={
        100: ('cb_recall', 'als'),  # ç¦»çº¿æ¨¡å‹ALSå¬å›ï¼Œrecall:user:1115629498121 column=als:18
        101: ('cb_recall', 'content'),  # ç¦»çº¿word2vecçš„ç”»åƒå†…å®¹å¬å› 'recall:user:5', 'content:1'
        102: ('cb_recall', 'online'),  # åœ¨çº¿word2vecçš„ç”»åƒå¬å› 'recall:user:1', 'online:1'
        103: 'new_article',  # æ–°æ–‡ç« å¬å› rediså½“ä¸­    ch:18:new
        104: 'popular_article',  # åŸºäºç”¨æˆ·ååŒå¬å›ç»“æœ ch:18:hot
        105: ('article_similar', 'similar')  # æ–‡ç« ç›¸ä¼¼æ¨èç»“æœ '1' 'similar:2'
    },
    SORT={
        200: 'LR',
    },
    CHANNEL=25,
    BYPASS=[
            {
                &quot;Bucket&quot;: ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd'],
                &quot;Strategy&quot;: &quot;Algo-1&quot;
            },
            {
                &quot;BeginBucket&quot;: ['e', 'f'],
                &quot;Strategy&quot;: &quot;Algo-2&quot;
            }
        ]
)
</code></pre>
<h2 id="å®éªŒä¸­å¿ƒæµé‡åˆ‡åˆ†">å®éªŒä¸­å¿ƒæµé‡åˆ‡åˆ†</h2>
<ul>
<li>å“ˆå¸Œåˆ†æ¡¶ï¼Œmd5</li>
<li>æ¨èåˆ·æ–°é€»è¾‘(é€šè¿‡æ—¶é—´æˆ³åŒºåˆ†ä¸»è¦é€»è¾‘)</li>
</ul>
<p>ABTeståˆ†æµé€»è¾‘å®ç°ä»£ç å¦‚ä¸‹</p>
<pre><code>import hashlib
from setting.default import DefaultConfig, RAParam

def feed_recommend(user_id, channel_id, article_num, time_stamp):
    &quot;&quot;&quot;
    1ã€æ ¹æ®webæä¾›çš„å‚æ•°ï¼Œè¿›è¡Œåˆ†æµ
    2ã€æ‰¾åˆ°å¯¹åº”çš„ç®—æ³•ç»„åˆä¹‹åï¼Œå»æ¨èä¸­å¿ƒè°ƒç”¨ä¸åŒçš„å¬å›å’Œæ’åºæœåŠ¡
    3ã€è¿›è¡ŒåŸ‹ç‚¹å‚æ•°å°è£…
    :param user_id:ç”¨æˆ·id
    :param article_num:æ¨èæ–‡ç« ä¸ªæ•°
    :return: track:åŸ‹ç‚¹å‚æ•°ç»“æœ: å‚è€ƒä¸Šé¢åŸ‹ç‚¹å‚æ•°ç»„åˆ
    &quot;&quot;&quot;

    #  äº§å“å‰æœŸæ¨èç”±äºè¾ƒå°‘çš„ç‚¹å‡»è¡Œä¸ºï¼Œæ‰€ä»¥å»åš ç”¨æˆ·å†·å¯åŠ¨ + æ–‡ç« å†·å¯åŠ¨
    # ç”¨æˆ·å†·å¯åŠ¨ï¼š'æ¨è'é¢‘é“ï¼šçƒ­é—¨é¢‘é“çš„å¬å›+ç”¨æˆ·å®æ—¶è¡Œä¸ºç”»åƒå¬å›ï¼ˆåœ¨çº¿çš„ä¸ä¿å­˜ç”»åƒï¼‰  'C2'ç»„åˆ
    #            # å…¶å®ƒé¢‘é“ï¼šçƒ­é—¨å¬å› + æ–°æ–‡ç« å¬å›   'C1'ç»„åˆ
    # å®šä¹‰è¿”å›å‚æ•°çš„ç±»
    class TempParam(object):
        user_id = -10
        channel_id = -10
        article_num = -10
        time_stamp = -10
        algo = &quot;&quot;

    temp = TempParam()
    temp.user_id = user_id
    temp.channel_id = channel_id
    temp.article_num = article_num
    # è¯·æ±‚çš„æ—¶é—´æˆ³å¤§å°
    temp.time_stamp = time_stamp

    # å…ˆè¯»å–ç¼“å­˜æ•°æ®redis+å¾…æ¨èhbaseç»“æœ
    # å¦‚æœæœ‰è¿”å›å¹¶åŠ ä¸ŠåŸ‹ç‚¹å‚æ•°
    # å¹¶ä¸”å†™å…¥hbase å½“å‰æ¨èæ—¶é—´æˆ³ç”¨æˆ·ï¼ˆç™»å½•å’ŒåŒ¿åï¼‰çš„å†å²æ¨èæ–‡ç« åˆ—è¡¨

    # ä¼ å…¥ç”¨æˆ·idä¸ºç©ºçš„ç›´æ¥å¬å›ç»“æœ
    if temp.user_id == &quot;&quot;:
        temp.algo = &quot;&quot;
        return add_track([], temp)
    # è¿›è¡Œåˆ†æ¡¶å®ç°åˆ†æµï¼Œåˆ¶å®šä¸åŒçš„å®éªŒç­–ç•¥
    bucket = hashlib.md5(user_id.encode()).hexdigest()[:1]
    if bucket in RAParam.BYPASS[0]['Bucket']:
        temp.algo = RAParam.BYPASS[0]['Strategy']
    else:
        temp.algo = RAParam.BYPASS[1]['Strategy']

    # æ¨èæœåŠ¡ä¸­å¿ƒæ¨èç»“æœ(è¿™é‡Œåšæµ‹è¯•)
    track = add_track([], temp)

    return track
</code></pre>
<h1 id="æ¨èä¸­å¿ƒé€»è¾‘">æ¨èä¸­å¿ƒé€»è¾‘</h1>
<h2 id="æ¨èä¸­å¿ƒæ¨èå­˜å‚¨è®¾è®¡">æ¨èä¸­å¿ƒæ¨èå­˜å‚¨è®¾è®¡</h2>
<p>HBASE æ•°æ®åº“è¡¨è®¾è®¡</p>
<ul>
<li>wait_recommend: ç»è¿‡å„ç§å¤šè·¯å¬å›ï¼Œæ’åºä¹‹åçš„å¾…æ¨èç»“æœä¿å­˜
<ul>
<li>åªè¦åˆ·æ–°ä¸€æ¬¡ï¼Œæ²¡æœ‰ç¼“å­˜ï¼Œæ‰ä¸»åŠ¨æ”¶é›†å„ç§å¬å›é›†åˆä¸€èµ·ç»™wait_recommendå†™å…¥ï¼Œæ‰€ä»¥ä¸ç”¨è®¾ç½®å¤šä¸ªç‰ˆæœ¬</li>
</ul>
</li>
<li>history_recommend: æ¯æ¬¡çœŸæ­£æ¨èå‡ºå»ç»™ç”¨æˆ·çš„å†å²æ¨èç»“æœåˆ—è¡¨
<ul>
<li>æŒ‰ç…§é¢‘é“å­˜å‚¨ç”¨æˆ·çš„å†å²æ¨èç»“æœ</li>
<li>éœ€è¦ä¿ç•™å¤šä¸ªç‰ˆæœ¬ï¼Œæ‰éœ€è¦å»ºç«‹ç‰ˆæœ¬ä¿¡æ¯</li>
</ul>
</li>
</ul>
<p>åˆ›å»ºä¸€ä¸ªå­˜å‚¨è¡¨ï¼ˆç”¨æ¥å­˜å‚¨æ’åºåæ¨èå‡ºå»åï¼Œ å‰©ä½™çš„Itemï¼‰ï¼š</p>
<pre><code>create 'wait_recommend', 'channel'

put 'wait_recommend', 'reco:1', 'channel:18', [17283, 140357, 14668, 15182, 17999, 13648, 12884, 17302, 13846, 18135]
put 'wait_recommend', 'reco:1', 'channel:0', [17283, 140357, 14668, 15182, 17999, 13648, 12884, 17302, 13846, 18135]
</code></pre>
<p>åˆ›å»ºä¸€ä¸ªå†å²hbaseç»“æœï¼ˆç”¨äºå­˜å‚¨æ¨èè¿‡çš„Itemï¼‰ï¼š</p>
<pre><code>create 'history_recommend', {NAME=&gt;'channel', TTL=&gt;7776000, VERSIONS=&gt;999999}   86400
# æ¯æ¬¡æŒ‡å®šä¸€ä¸ªæ—¶é—´æˆ³,å¯ä»¥è¾¾åˆ°ä¸åŒç‰ˆæœ¬çš„æ•ˆæœ
put 'history_recommend', 'reco:his:1', 'channel:18', [17283, 140357, 14668, 15182, 17999, 13648, 12884, 17302, 13846, 18135]


# ä¿®æ”¹çš„æ—¶å€™å¿…é¡»æŒ‡å®šfamilyåç§°
hbase(main):084:0&gt; alter 'history_recommend',NAME =&gt; 'channel', TTL =&gt; '7776000'
Updating all regions with the new schema...
1/1 regions updated.
Done.
Took 2.0578 seconds

alter 'history_recommend',NAME =&gt; 'channel', VERSIONS=&gt;999999, TTL=&gt;7776000
</code></pre>
<p>æ”¾å…¥å†å²æ•°æ®ï¼Œå­˜åœ¨æ—¶é—´æˆ³ï¼Œåˆ°æ—¶å€™å–å‡ºå†å²æ•°æ®å°±æ˜¯æ¯ä¸ªç”¨æˆ·çš„å†å²æ—¶é—´æˆ³å¯ä»¥</p>
<pre><code>get &quot;history_recommend&quot;, 'reco:his:1', {COLUMN=&gt;'channel:18',VERSIONS=&gt;1000, TIMESTAMP=&gt;1546242869000}
</code></pre>
<p>ğŸ‘è¿™é‡Œä¸ä¸Šæ¬¡å¬å›cb_recallä»¥åŠhistory_recallæœ‰ä¸åŒç”¨å¤„ï¼š</p>
<ul>
<li>history_recall:å­˜æ”¾å¬å›è¿‡çš„æ•°æ®ï¼Œç”¨æˆ·è¿‡æ»¤æ¨èåˆå§‹çš„äº§ç”Ÿç»“æœ</li>
<li>history_recommend:å­˜æ”¾çš„æ˜¯æŸä¸ªç”¨æˆ·åœ¨æŸé¢‘é“çš„çœŸæ­£æ¨èè¿‡çš„å†å²è®°å½•
<ul>
<li>åŒæ—¶è¿‡æ»¤æ‰æ–°æ–‡ç« å’Œçƒ­é—¨æ–‡ç« çš„æ¨èç»“æœ</li>
</ul>
</li>
</ul>
<h2 id="feedæµ-æ¨èä¸­å¿ƒé€»è¾‘">feedæµ æ¨èä¸­å¿ƒé€»è¾‘</h2>
<ul>
<li>ç›®çš„ï¼šæ ¹æ®ABTeståˆ†æµä¹‹åçš„ç”¨æˆ·ï¼Œè¿›è¡Œåˆ¶å®šç®—æ³•çš„å¬å›å’Œæ’åºè¯»å–</li>
<li>æ­¥éª¤ï¼š
<ul>
<li>1ã€Hbaseæ•°æ®åº“å·¥å…·å°è£…ä»‹ç»</li>
<li>2ã€feedæ—¶é—´æˆ³è¿›è¡Œæ¨èé€»è¾‘åˆ¤æ–­</li>
<li>2ã€è¯»å–å¬å›ç»“æœ(æ— å®æ—¶æ’åº)</li>
</ul>
</li>
</ul>
<p>åˆ›å»ºç‰¹å¾ä¸­å¿ƒç±»ï¼š</p>
<pre><code>import os
import sys

BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(BASE_DIR))
import hashlib
from setting.default import RAParam
from server.utils import HBaseUtils
from server import pool
from server import recall_service
from datetime import datetime
import logging
import json

logger = logging.getLogger('recommend')


def add_track(res, temp):
    &quot;&quot;&quot;
    å°è£…åŸ‹ç‚¹å‚æ•°
    :param res: æ¨èæ–‡ç« idåˆ—è¡¨
    :param cb: åˆå¹¶å‚æ•°
    :param rpc_param: rpcå‚æ•°
    :return: åŸ‹ç‚¹å‚æ•°
        æ–‡ç« åˆ—è¡¨å‚æ•°
        å•æ–‡ç« å‚æ•°
    &quot;&quot;&quot;
    # æ·»åŠ åŸ‹ç‚¹å‚æ•°
    track = {}

    # å‡†å¤‡æ›å…‰å‚æ•°
    # å…¨éƒ¨å­—ç¬¦ä¸²å½¢å¼æä¾›ï¼Œåœ¨hiveç«¯ä¸ä¼šè§£æé—®é¢˜
    _exposure = {&quot;action&quot;: &quot;exposure&quot;, &quot;userId&quot;: temp.user_id, &quot;articleId&quot;: json.dumps(res),
                &quot;algorithmCombine&quot;: temp.algo}

    track['param'] = json.dumps(_exposure)
    track['recommends'] = []

    # å‡†å¤‡å…¶å®ƒç‚¹å‡»å‚æ•°
    for _id in res:
        # æ„é€ å­—å…¸
        _dic = {}
        _dic['article_id'] = _id
        _dic['param'] = {}

        # å‡†å¤‡clickå‚æ•°
        _p = {&quot;action&quot;: &quot;click&quot;, &quot;userId&quot;: temp.user_id, &quot;articleId&quot;: str(_id),
            &quot;algorithmCombine&quot;: temp.algo}

        _dic['param']['click'] = json.dumps(_p)
        # å‡†å¤‡collectå‚æ•°
        _p[&quot;action&quot;] = 'collect'
        _dic['param']['collect'] = json.dumps(_p)
        # å‡†å¤‡shareå‚æ•°
        _p[&quot;action&quot;] = 'share'
        _dic['param']['share'] = json.dumps(_p)
        # å‡†å¤‡detentionTimeå‚æ•°
        _p[&quot;action&quot;] = 'read'
        _dic['param']['read'] = json.dumps(_p)

        track['recommends'].append(_dic)

    track['timestamp'] = temp.time_stamp
    return track


class RecoCenter(object):
    &quot;&quot;&quot;æ¨èä¸­å¿ƒ
    &quot;&quot;&quot;
    def __init__(self):
        self.hbu = HBaseUtils(pool)
        # self.recall_service = recall_service.ReadRecall()
</code></pre>
<p>å¹¶ä¸”æ·»åŠ äº†è·å–ç»“æœæ‰“å°æ—¥å¿—è®¾ç½®</p>
<pre><code># å®æ–½æ¨èæ—¥å¿—
# ç¦»çº¿å¤„ç†æ›´æ–°æ‰“å°æ—¥å¿—
trace_file_handler = logging.FileHandler(
os.path.join(logging_file_dir, 'recommend.log')
)
trace_file_handler.setFormatter(logging.Formatter('%(message)s'))
log_trace = logging.getLogger('recommend')
log_trace.addHandler(trace_file_handler)
log_trace.setLevel(logging.INFO)
</code></pre>
<h2 id="hbaseè¯»å–å­˜å‚¨ç­‰å·¥å…·ç±»å°è£…">Hbaseè¯»å–å­˜å‚¨ç­‰å·¥å…·ç±»å°è£…</h2>
<ul>
<li>get_table_row(self, table_name, key_format, column_format=None, include_timestamp=False):
<ul>
<li>è·å–å…·ä½“è¡¨ä¸­çš„é”®ã€åˆ—æ—ä¸­çš„è¡Œæ•°æ®</li>
</ul>
</li>
<li>get_table_cells(self, table_name, key_format, column_format=None, timestamp=None, include_timestamp=False):
<ul>
<li>è·å–Hbaseä¸­å¤šä¸ªç‰ˆæœ¬æ•°æ®</li>
</ul>
</li>
<li>get_table_put(self, table_name, key_format, column_format, data, timestamp=None):
<ul>
<li>å­˜å‚¨æ•°æ®åˆ°Hbaseå½“ä¸­</li>
</ul>
</li>
<li>get_table_delete(self, table_name, key_format, column_format):
<ul>
<li>åˆ é™¤Hbaseä¸­çš„æ•°æ®</li>
</ul>
</li>
</ul>
<p>å°è£…ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code>class HBaseUtils(object):
    &quot;&quot;&quot;HBaseæ•°æ®åº“è¯»å–å·¥å…·ç±»
    &quot;&quot;&quot;
    def __init__(self, connection):
        self.pool = connection

    def get_table_row(self, table_name, key_format, column_format=None, include_timestamp=False):
        &quot;&quot;&quot;
        è·å–HBaseæ•°æ®åº“ä¸­çš„è¡Œè®°å½•æ•°æ®
        :param table_name: è¡¨å
        :param key_format: keyæ ¼å¼å­—ç¬¦ä¸², å¦‚è¡¨çš„'user:reco:1', ç±»å‹ä¸ºbytes
        :param column_format: column, åˆ—æ—å­—ç¬¦ä¸²,å¦‚è¡¨çš„ column 'als:18',ç±»å‹ä¸ºbytes
        :param include_timestamp: æ˜¯å¦åŒ…å«æ—¶é—´æˆ³
        :return: è¿”å›æ•°æ®åº“ç»“æœdata
        &quot;&quot;&quot;
        if not isinstance(key_format, bytes):
            raise KeyError(&quot;key_format or column type error&quot;)

        if not isinstance(table_name, str):
            raise KeyError(&quot;table_name should str type&quot;)

        with self.pool.connection() as conn:
            table = conn.table(table_name)

            if column_format:
                data = table.row(row=key_format, columns=[column_format], include_timestamp=include_timestamp)
            else:
                data = table.row(row=key_format)
            conn.close()

        if column_format:
            return data[column_format]
        else:
            # [(b'[141440]', 1555519429582)]
            # {'[141440]'}
            return data

    def get_table_cells(self, table_name, key_format, column_format=None, timestamp=None, include_timestamp=False):
        &quot;&quot;&quot;
        è·å–HBaseæ•°æ®åº“ä¸­å¤šä¸ªç‰ˆæœ¬æ•°æ®
        :param table_name: è¡¨å
        :param key_format: keyæ ¼å¼å­—ç¬¦ä¸², å¦‚è¡¨çš„'user:reco:1', ç±»å‹ä¸ºbytes
        :param column_format: column, åˆ—æ—å­—ç¬¦ä¸²,å¦‚è¡¨çš„ column 'als:18',ç±»å‹ä¸ºbytes
        :param timestamp: æŒ‡å®šå°äºè¯¥æ—¶é—´æˆ³çš„æ•°æ®
        :param include_timestamp: æ˜¯å¦åŒ…å«æ—¶é—´æˆ³
        :return: è¿”å›æ•°æ®åº“ç»“æœdata
        &quot;&quot;&quot;
        if not isinstance(key_format, bytes) or not isinstance(column_format, bytes):
            raise KeyError(&quot;key_format or column type error&quot;)

        if not isinstance(table_name, str):
            raise KeyError(&quot;table_name should str type&quot;)

        with self.pool.connection() as conn:
            table = conn.table(table_name)

            data = table.cells(row=key_format, column=column_format, timestamp=timestamp,
                            include_timestamp=include_timestamp)

            conn.close()
        # [(,), ()]
        return data

    def get_table_put(self, table_name, key_format, column_format, data, timestamp=None):
        &quot;&quot;&quot;

        :param table_name: è¡¨å
        :param key_format: keyæ ¼å¼å­—ç¬¦ä¸², å¦‚è¡¨çš„'user:reco:1', ç±»å‹ä¸ºbytes
        :param column_format: column, åˆ—æ—å­—ç¬¦ä¸²,å¦‚è¡¨çš„ column 'als:18',ç±»å‹ä¸ºbytes
        :param data: æ’å…¥çš„æ•°æ®
        :param timestamp: æŒ‡å®šæ‹†å…¥æ•°æ®çš„æ—¶é—´æˆ³
        :return: None
        &quot;&quot;&quot;
        if not isinstance(key_format, bytes) or not isinstance(column_format, bytes) or not isinstance(data, bytes):
            raise KeyError(&quot;key_format or column or data type error&quot;)

        if not isinstance(table_name, str):
            raise KeyError(&quot;table_name should str type&quot;)

        with self.pool.connection() as conn:
            table = conn.table(table_name)

            table.put(key_format, {column_format: data}, timestamp=timestamp)

            conn.close()
        return None

    def get_table_delete(self, table_name, key_format, column_format):
        &quot;&quot;&quot;
        åˆ é™¤åˆ—æ—ä¸­çš„å†…å®¹
        :param table_name: è¡¨åç§°
        :param key_format: key
        :param column_format: åˆ—æ ¼å¼
        :return:
        &quot;&quot;&quot;
        if not isinstance(key_format, bytes) or not isinstance(column_format, bytes):
            raise KeyError(&quot;key_format or column type error&quot;)

        if not isinstance(table_name, str):
            raise KeyError(&quot;table_name should str type&quot;)
        with self.pool.connection() as conn:
            table = conn.table(table_name)
            table.delete(row=key_format, columns=[column_format])
            conn.close()
        return None
</code></pre>
<h3 id="å¢åŠ feed_recommend_logicå‡½æ•°è¿›è¡Œæ—¶é—´æˆ³é€»è¾‘åˆ¤æ–­">å¢åŠ feed_recommend_logicå‡½æ•°ï¼Œè¿›è¡Œæ—¶é—´æˆ³é€»è¾‘åˆ¤æ–­</h3>
<h3 id="æ ¹æ®æ—¶é—´æˆ³">æ ¹æ®æ—¶é—´æˆ³</h3>
<ul>
<li>æ—¶é—´æˆ³Tå°äºHBASEå†å²æ¨èè®°å½•
<ul>
<li>åˆ™è·å–å†å²è®°å½•ï¼Œè¿”å›è¯¥æ—¶é—´æˆ³Tä¸Šæ¬¡çš„æ—¶é—´æˆ³T-1</li>
</ul>
</li>
<li>æ—¶é—´æˆ³Tå¤§äºHBASEå†å²æ¨èè®°å½•ï¼Œåˆ™è·å–æ–°æ¨èï¼Œåˆ™è·å–HBASEæ•°æ®åº“ä¸­æœ€è¿‘çš„ä¸€æ¬¡æ—¶é—´æˆ³
<ul>
<li>å¦‚æœæœ‰ç¼“å­˜ï¼Œä»ç¼“å­˜ä¸­æ‹¿ï¼Œå¹¶ä¸”å†™å…¥æ¨èå†å²è¡¨ä¸­</li>
<li>å¦‚æœæ²¡æœ‰ç¼“å­˜ï¼Œå°±è¿›è¡Œä¸€æ¬¡æŒ‡å®šç®—æ³•ç»„åˆçš„å¬å›ç»“æœè¯»å–ï¼Œæ’åºï¼Œç„¶åå†™å…¥å¾…æ¨èwait_recommendä¸­ï¼Œå…¶ä¸­æ¨èå‡ºå»çš„æ”¾å…¥å†å²æ¨èè¡¨ä¸­</li>
</ul>
</li>
</ul>
<p>è·å–è¿™ä¸ªç”¨æˆ·è¯¥é¢‘é“çš„å†å²ç»“æœ</p>
<pre><code># åˆ¤æ–­ç”¨è¯·æ±‚çš„æ—¶é—´æˆ³å¤§å°å†³å®šè·å–å†å²è®°å½•è¿˜æ˜¯åˆ·æ–°æ¨èæ–‡ç« 
        try:
            last_stamp = self.hbu.get_table_row('history_recommend', 'reco:his:{}'.format(temp.user_id).encode(),
                                                'channel:{}'.format(temp.channel_id).encode(), include_timestamp=True)[
                1]
            logger.info(&quot;{} INFO get user_id:{} channel:{} history last_stamp&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
        except Exception as e:
            logger.warning(&quot;{} WARN read history recommend exception:{}&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
            last_stamp = 0
</code></pre>
<p>å¦‚æœå†å²æ—¶é—´æˆ³æœ€è¿‘çš„ä¸€æ¬¡å°äºç”¨æˆ·è¯·æ±‚æ—¶å€™çš„æ—¶é—´æˆ³ï¼ˆHbaseçš„æ—¶é—´æˆ³æ˜¯time.time() * 1000è¿™ä¸ªå€¼çš„å¤§å°ï¼Œä¸Webåå°ä¼ å…¥çš„ä¸€æ ·ç±»å‹ï¼Œå¦‚æœWebåå°ä¼ å…¥çš„ä¸æ˜¯æ­¤å¤§å°ï¼Œæ³¨æ„ä¿®æ”¹ï¼‰ã€‚<br>
åˆ™è¿”å›æ¨èç»“æœä»¥åŠæ­¤æ¬¡è¯·æ±‚çš„ä¸Šä¸€æ¬¡æ—¶é—´æˆ³ï¼ˆç”¨äºç”¨æˆ·è·å–å†å²è®°å½•ï¼‰ã€‚</p>
<pre><code>if last_stamp &lt; temp.time_stamp:
            # 1ã€è·å–ç¼“å­˜
            # res = redis_cache.get_reco_from_cache(temp, self.hbu)
            #
            # # å¦‚æœæ²¡æœ‰ï¼Œç„¶åèµ°ä¸€éç®—æ³•æ¨è å¬å›+æ’åºï¼ŒåŒæ—¶å†™å…¥åˆ°hbaseå¾…æ¨èç»“æœåˆ—è¡¨
            # if not res:
            #     logger.info(&quot;{} INFO get user_id:{} channel:{} recall/sort data&quot;.
            #                 format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
            #
            #     res = self.user_reco_list(temp)

            # 2ã€ç›´æ¥æ‹¿æ¨èç»“æœ
            # res = self.user_reco_list(temp)

            #temp.time_stamp = int(last_stamp)

            track = add_track([], temp)
</code></pre>
<p>å¦‚æœå†å²æ—¶é—´æˆ³å¤§äºç”¨æˆ·è¯·æ±‚çš„è¿™æ¬¡æ—¶é—´æˆ³ï¼Œé‚£ä¹ˆå°±æ˜¯åœ¨è·å–å†å²è®°å½•ï¼Œç”¨æˆ·è¯·æ±‚çš„å†å²æ—¶é—´æˆ³æ˜¯å…·ä½“æŸä¸ªå†å²è®°å½•çš„æ—¶é—´æˆ³Tï¼ŒHbaseå½“ä¸­ä¸èƒ½å¤Ÿç›´æ¥ç”¨Tå»è·å–ï¼Œè€Œéœ€è¦å»ï¼ˆT+Nï¼‰&gt;Tçš„æ—¶é—´æˆ³è·å–ï¼Œæ‰èƒ½æ‹¿åˆ°åŒ…å«Tæ—¶é—´çš„ç»“æœï¼Œå¹¶ä¸”ä½¿ç”¨get_table_cellså»è·å–ã€‚</p>
<p>åˆ†ä»¥ä¸‹æƒ…å†µè€ƒè™‘ï¼š</p>
<ul>
<li>1ã€å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œè¿”å›æ—¶é—´æˆ³0ä»¥åŠç»“æœç©ºåˆ—è¡¨</li>
<li>2ã€å¦‚æœå†å²æ•°æ®åªæœ‰ä¸€æ¡ï¼Œè¿”å›è¿™ä¸€æ¡å†å²æ•°æ®ä»¥åŠæ—¶é—´æˆ³æ­£å¥½ä¸ºè¯·æ±‚æ—¶é—´æˆ³ï¼Œä¿®æ”¹æ—¶é—´æˆ³ä¸º0ï¼Œè¡¨ç¤ºåé¢è¯·æ±‚ä»¥åå°±æ²¡æœ‰å†å²æ•°æ®äº†(APPçš„è¡Œä¸ºå°±æ˜¯ç¿»å†å²è®°å½•åœæ­¢äº†)</li>
<li>3ã€å¦‚æœå†å²æ•°æ®å¤šæ¡ï¼Œè¿”å›æœ€è¿‘çš„ç¬¬ä¸€æ¡å†å²æ•°æ®ï¼Œç„¶åè¿”å›ä¹‹åç¬¬äºŒæ¡å†å²æ•°æ®çš„æ—¶é—´æˆ³</li>
</ul>
<p>æ¥ç€ä¸Šé¢çš„ifï¼Œå†™ä»£ç ï¼š</p>
<pre><code>else:

    logger.info(&quot;{} INFO read user_id:{} channel:{} history recommend data&quot;.format(
        datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

    try:
        row = self.hbu.get_table_cells('history_recommend',
                                        'reco:his:{}'.format(temp.user_id).encode(),
                                        'channel:{}'.format(temp.channel_id).encode(),
                                        timestamp=temp.time_stamp + 1,
                                        include_timestamp=True)
    except Exception as e:
        logger.warning(&quot;{} WARN read history recommend exception:{}&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
        row = []
        res = []

    # 1ã€å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œè¿”å›æ—¶é—´æˆ³0ä»¥åŠç»“æœç©ºåˆ—è¡¨
    # 2ã€å¦‚æœå†å²æ•°æ®åªæœ‰ä¸€æ¡ï¼Œè¿”å›è¿™ä¸€æ¡å†å²æ•°æ®ä»¥åŠæ—¶é—´æˆ³æ­£å¥½ä¸ºè¯·æ±‚æ—¶é—´æˆ³ï¼Œä¿®æ”¹æ—¶é—´æˆ³ä¸º0
    # 3ã€å¦‚æœå†å²æ•°æ®å¤šæ¡ï¼Œè¿”å›æœ€è¿‘ä¸€æ¡å†å²æ•°æ®ï¼Œç„¶åè¿”å›
    if not row:
        temp.time_stamp = 0
        res = []
    elif len(row) == 1 and row[0][1] == temp.time_stamp:
        res = eval(row[0][0])
        temp.time_stamp = 0
    elif len(row) &gt;= 2:
        res = eval(row[0][0])
        temp.time_stamp = int(row[1][1])

    res = list(map(int, res))
    logger.info(
        &quot;{} INFO history:{}, {}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), res, temp.time_stamp))
    track = add_track(res, temp)
    # æ›å…‰å‚æ•°è®¾ç½®ä¸ºç©º
    track['param'] = ''

return track
</code></pre>
<p>å®Œæ•´ä»£ç ï¼š</p>
<pre><code>def feed_recommend_logic(self, temp):
    &quot;&quot;&quot;æ¨èæµä¸šåŠ¡é€»è¾‘
    :param temp:ABTestä¼ å…¥çš„ä¸šåŠ¡è¯·æ±‚å‚æ•°
    &quot;&quot;&quot;

    # åˆ¤æ–­ç”¨è¯·æ±‚çš„æ—¶é—´æˆ³å¤§å°å†³å®šè·å–å†å²è®°å½•è¿˜æ˜¯åˆ·æ–°æ¨èæ–‡ç« 
    try:
        last_stamp = self.hbu.get_table_row('history_recommend', 'reco:his:{}'.format(temp.user_id).encode(),
                                            'channel:{}'.format(temp.channel_id).encode(), include_timestamp=True)[1]
        logger.info(&quot;{} INFO get user_id:{} channel:{} history last_stamp&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
    except Exception as e:
        logger.warning(&quot;{} WARN read history recommend exception:{}&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
        last_stamp = 0

    # å¦‚æœå°äºï¼Œèµ°ä¸€éæ­£å¸¸çš„æ¨èæµç¨‹ï¼Œç¼“å­˜æˆ–è€…å¬å›æ’åº
    logger.info(&quot;{} INFO history last_stamp:{},temp.time_stamp:{}&quot;.
                format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), last_stamp, temp.time_stamp))
    if last_stamp &lt; temp.time_stamp:

        # è·å–
        res = redis_cache.get_reco_from_cache(temp, self.hbu)

        # å¦‚æœæ²¡æœ‰ï¼Œç„¶åèµ°ä¸€éç®—æ³•æ¨è å¬å›+æ’åºï¼ŒåŒæ—¶å†™å…¥åˆ°hbaseå¾…æ¨èç»“æœåˆ—è¡¨
        if not res:
            logger.info(&quot;{} INFO get user_id:{} channel:{} recall/sort data&quot;.
                        format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

            res = self.user_reco_list(temp)

        temp.time_stamp = int(last_stamp)

        track = add_track(res, temp)

    else:

        logger.info(&quot;{} INFO read user_id:{} channel:{} history recommend data&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

        try:
            row = self.hbu.get_table_cells('history_recommend',
                                      'reco:his:{}'.format(temp.user_id).encode(),
                                      'channel:{}'.format(temp.channel_id).encode(),
                                      timestamp=temp.time_stamp + 1,
                                      include_timestamp=True)
        except Exception as e:
            logger.warning(&quot;{} WARN read history recommend exception:{}&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
            row = []
            res = []

        # 1ã€å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œè¿”å›æ—¶é—´æˆ³0ä»¥åŠç»“æœç©ºåˆ—è¡¨
        # 2ã€å¦‚æœå†å²æ•°æ®åªæœ‰ä¸€æ¡ï¼Œè¿”å›è¿™ä¸€æ¡å†å²æ•°æ®ä»¥åŠæ—¶é—´æˆ³æ­£å¥½ä¸ºè¯·æ±‚æ—¶é—´æˆ³ï¼Œä¿®æ”¹æ—¶é—´æˆ³ä¸º0
        # 3ã€å¦‚æœå†å²æ•°æ®å¤šæ¡ï¼Œè¿”å›æœ€è¿‘ä¸€æ¡å†å²æ•°æ®ï¼Œç„¶åè¿”å›
        if not row:
            temp.time_stamp = 0
            res = []
        elif len(row) == 1 and row[0][1] == temp.time_stamp:
            res = eval(row[0][0])
            temp.time_stamp = 0
        elif len(row) &gt;= 2:
            res = eval(row[0][0])
            temp.time_stamp = int(row[1][1])

        res = list(map(int, res))
        logger.info(
            &quot;{} INFO history:{}, {}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), res, temp.time_stamp))
        track = add_track(res, temp)
        # æ›å…‰å‚æ•°è®¾ç½®ä¸ºç©º
        track['param'] = ''
    return track
</code></pre>
<h2 id="ä¿®æ”¹abtestä¸­çš„æ¨èè°ƒç”¨">ä¿®æ”¹ABTestä¸­çš„æ¨èè°ƒç”¨</h2>
<pre><code>from server.reco_center import RecoCenter

# æ¨è
track = RecoCenter().feed_recommend_logic(temp)
</code></pre>
<h1 id="æ¨èä¸­å¿ƒæ—¶é—´æˆ³è·å–é€»è¾‘æµ‹è¯•">æ¨èä¸­å¿ƒæ—¶é—´æˆ³è·å–é€»è¾‘æµ‹è¯•</h1>
<p>è·å–å¤šç‰ˆæœ¬å†å²è®°å½•ï¼š</p>
<pre><code>hbase(main):045:0&gt; get 'history_recommend', 'reco:his:1115629498121846784', {COLUMN=&gt;'channel:18', VERSIONS=&gt;999999}
COLUMN                     CELL                                                                        
channel:18                timestamp=1559148615353, value=[15140, 16421, 19494, 14381, 17966]          
channel:18                timestamp=1558236647437, value=[18904, 14300, 44412, 18238, 18103, 43986, 44
                        339, 17454, 14899, 18335]                                                   
channel:18                timestamp=1558236629309, value=[43997, 14299, 17632, 17120]                 
channel:18                timestamp=1558236535794, value=[44657, 15085, 18156, 44654, 19052, 44652, 18
                        795, 17385, 44137, 17889]
</code></pre>
<h1 id="å¬å›é›†è¯»å–ä¸æ¨èä¸­å¿ƒå¯¹æ¥">å¬å›é›†è¯»å–ä¸æ¨èä¸­å¿ƒå¯¹æ¥</h1>
<ul>
<li>æ·»åŠ ä¸€ä¸ªserverçš„ç›®å½•
<ul>
<li>å¬å›è¯»å–æœåŠ¡</li>
<li>æ·»åŠ ä¸€ä¸ªå¬å›é›†çš„ç»“æœè¯»å–æœåŠ¡recall_service.py</li>
</ul>
</li>
</ul>
<h2 id="å¤šè·¯å¬å›ç»“æœè¯»å–">å¤šè·¯å¬å›ç»“æœè¯»å–</h2>
<ul>
<li>ç›®çš„ï¼šè¯»å–ç¦»çº¿å’Œåœ¨çº¿å­˜å‚¨çš„å¬å›ç»“æœ
<ul>
<li>hbaseçš„å­˜å‚¨ï¼šcb_recall, als, content, online</li>
</ul>
</li>
<li>æ­¥éª¤ï¼š
<ul>
<li>1ã€åˆå§‹åŒ–redis,hbaseç›¸å…³å·¥å…·</li>
<li>2ã€åœ¨çº¿ç”»åƒå¬å›ï¼Œç¦»çº¿ç”»åƒå¬å›ï¼Œç¦»çº¿ååŒå¬å›æ•°æ®çš„è¯»å–</li>
<li>3ã€redisæ–°æ–‡ç« å’Œçƒ­é—¨æ–‡ç« ç»“æœè¯»å–</li>
<li>4ã€ç›¸ä¼¼æ–‡ç« è¯»å–æ¥å£</li>
</ul>
</li>
</ul>
<p>åˆå§‹åŒ–redis,hbaseç›¸å…³å·¥å…·</p>
<pre><code>import os
import sys
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(BASE_DIR))

from server import redis_client
from server import pool
import logging
from datetime import datetime
from server.utils import HBaseUtils

logger = logging.getLogger('recommend')


class ReadRecall(object):
    &quot;&quot;&quot;è¯»å–å¬å›é›†çš„ç»“æœ
    &quot;&quot;&quot;
    def __init__(self):
        self.client = redis_client
        self.hbu = HBaseUtils(pool)
</code></pre>
<p>åœ¨initæ–‡ä»¶ä¸­æ·»åŠ ç›¸å…³åˆå§‹åŒ–æ•°æ®åº“å˜é‡</p>
<pre><code>import redis
import happybase
from setting.default import DefaultConfig
from pyspark import SparkConf
from pyspark.sql import SparkSession


pool = happybase.ConnectionPool(size=10, host=&quot;hadoop-master&quot;, port=9090)

# åŠ ä¸Šdecode_responses=Trueï¼Œå†™å…¥çš„é”®å€¼å¯¹ä¸­çš„valueä¸ºstrç±»å‹ï¼Œä¸åŠ è¿™ä¸ªå‚æ•°å†™å…¥çš„åˆ™ä¸ºå­—èŠ‚ç±»å‹ã€‚
redis_client = redis.StrictRedis(host=DefaultConfig.REDIS_HOST,
                                port=DefaultConfig.REDIS_PORT,
                                db=10,
                                decode_responses=True)
</code></pre>
<h3 id="åœ¨çº¿ç”»åƒå¬å›ç¦»çº¿ç”»åƒå¬å›ç¦»çº¿ååŒå¬å›æ•°æ®çš„è¯»å–">åœ¨çº¿ç”»åƒå¬å›ï¼Œç¦»çº¿ç”»åƒå¬å›ï¼Œç¦»çº¿ååŒå¬å›æ•°æ®çš„è¯»å–</h3>
<p>è¯»å–ç”¨æˆ·çš„æŒ‡å®šåˆ—æ—çš„å¬å›æ•°æ®ï¼Œå¹¶ä¸”è¯»å–ä¹‹åè¦åˆ é™¤åŸæ¥çš„æ¨èå¬å›ç»“æœ'cb_recall'</p>
<pre><code>def read_hbase_recall_data(self, table_name, key_format, column_format):
    &quot;&quot;&quot;
    è¯»å–cb_recallå½“ä¸­çš„æ¨èæ•°æ®
    è¯»å–çš„æ—¶å€™å¯ä»¥é€‰æ‹©åˆ—æ—è¿›è¡Œè¯»å–als, online, content

    :return:
    &quot;&quot;&quot;
    recall_list = []
    try:
        data = self.hbu.get_table_cells(table_name, key_format, column_format)

        # dataæ˜¯å¤šä¸ªç‰ˆæœ¬çš„æ¨èç»“æœ[[],[],[],]
        for _ in data:
            recall_list = list(set(recall_list).union(set(eval(_))))

        # self.hbu.get_table_delete(table_name, key_format, column_format)
    except Exception as e:
        logger.warning(&quot;{} WARN read {} recall exception:{}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                                                                 table_name, e))
    return recall_list
</code></pre>
<p>æµ‹è¯•ï¼š</p>
<pre><code>if __name__ == '__main__':
    rr = ReadRecall()
    # å¬å›ç»“æœçš„è¯»å–å°è£…
    print(rr.read_hbase_recall_data('cb_recall', b'recall:user:1114864874141253632', b'als:18'))
</code></pre>
<h3 id="redisæ–°æ–‡ç« å’Œçƒ­é—¨æ–‡ç« ç»“æœè¯»å–">redisæ–°æ–‡ç« å’Œçƒ­é—¨æ–‡ç« ç»“æœè¯»å–</h3>
<pre><code>def read_redis_new_article(self, channel_id):
    &quot;&quot;&quot;
    è¯»å–æ–°é—»ç« å¬å›ç»“æœ
    :param channel_id: æä¾›é¢‘é“
    :return:
    &quot;&quot;&quot;
    logger.warning(&quot;{} WARN read channel {} redis new article&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                                                             channel_id))
    _key = &quot;ch:{}:new&quot;.format(channel_id)
    try:
        res = self.client.zrevrange(_key, 0, -1)
    except Exception as e:
        logger.warning(&quot;{} WARN read new article exception:{}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
        res = []

    return list(map(int, res))
</code></pre>
<p>çƒ­é—¨æ–‡ç« è¯»å–:çƒ­é—¨æ–‡ç« è®°å½•äº†å¾ˆå¤šï¼Œå¯ä»¥é€‰å–å‰Kä¸ª:</p>
<pre><code>def read_redis_hot_article(self, channel_id):
    &quot;&quot;&quot;
    è¯»å–æ–°é—»ç« å¬å›ç»“æœ
    :param channel_id: æä¾›é¢‘é“
    :return:
    &quot;&quot;&quot;
    logger.warning(&quot;{} WARN read channel {} redis hot article&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), channel_id))
    _key = &quot;ch:{}:hot&quot;.format(channel_id)
    try:
        res = self.client.zrevrange(_key, 0, -1)

    except Exception as e:
        logger.warning(&quot;{} WARN read new article exception:{}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
        res = []

    # ç”±äºæ¯ä¸ªé¢‘é“çš„çƒ­é—¨æ–‡ç« æœ‰å¾ˆå¤šï¼Œå› ä¸ºä¿ç•™æ–‡ç« ç‚¹å‡»æ¬¡æ•°
    res = list(map(int, res))
    if len(res) &gt; self.hot_num:
        res = res[:self.hot_num]
    return res
</code></pre>
<p>æµ‹è¯•ï¼š</p>
<pre><code>print(rr.read_redis_new_article(18))
print(rr.read_redis_hot_article(18))
</code></pre>
<h3 id="ç›¸ä¼¼æ–‡ç« è¯»å–æ¥å£">ç›¸ä¼¼æ–‡ç« è¯»å–æ¥å£</h3>
<p>ä¼šæœ‰æ¥å£è·å–å›ºå®šçš„æ–‡ç« æ•°é‡(ç”¨åœ¨APPä¸­çš„çŒœä½ å–œæ¬¢æ¥å£)</p>
<pre><code>def read_hbase_article_similar(self, table_name, key_format, article_num):
    &quot;&quot;&quot;è·å–æ–‡ç« ç›¸ä¼¼ç»“æœ
    :param article_id: æ–‡ç« id
    :param article_num: æ–‡ç« æ•°é‡
    :return:
    &quot;&quot;&quot;
    # ç¬¬ä¸€ç§è¡¨ç»“æ„æ–¹å¼æµ‹è¯•ï¼š
    # create 'article_similar', 'similar'
    # put 'article_similar', '1', 'similar:1', 0.2
    # put 'article_similar', '1', 'similar:2', 0.34
    try:
        _dic = self.hbu.get_table_row(table_name, key_format)

        res = []
        _srt = sorted(_dic.items(), key=lambda obj: obj[1], reverse=True)
        if len(_srt) &gt; article_num:
            _srt = _srt[:article_num]
        for _ in _srt:
            res.append(int(_[0].decode().split(':')[1]))
    except Exception as e:
        logger.error(
            &quot;{} ERROR read similar article exception: {}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
        res = []
    return res
</code></pre>
<p>æµ‹è¯•ï¼š</p>
<pre><code>print(rr.read_hbase_article_similar('article_similar', b'116644', 10))
</code></pre>
<h2 id="å®Œæ•´ä»£ç ">å®Œæ•´ä»£ç </h2>
<pre><code>import os
import sys
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
sys.path.insert(0, os.path.join(BASE_DIR))

from server import redis_client
from server import pool
import logging
from datetime import datetime
from server.utils import HBaseUtils

logger = logging.getLogger('recommend')


class ReadRecall(object):
    &quot;&quot;&quot;è¯»å–å¬å›é›†çš„ç»“æœ
    &quot;&quot;&quot;
    def __init__(self):
        self.client = redis_client
        self.hbu = HBaseUtils(pool)

    def read_hbase_recall_data(self, table_name, key_format, column_format):
        &quot;&quot;&quot;è·å–æŒ‡å®šç”¨æˆ·çš„å¯¹åº”é¢‘é“çš„å¬å›ç»“æœ,åœ¨çº¿ç”»åƒå¬å›ï¼Œç¦»çº¿ç”»åƒå¬å›ï¼Œç¦»çº¿ååŒå¬å›
        :return:
        &quot;&quot;&quot;
        # è·å–familyå¯¹åº”çš„å€¼
        # æ•°æ®åº“ä¸­çš„é”®éƒ½æ˜¯bytesç±»å‹ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç¼–ç ç›¸åŠ 
        # è¯»å–å¬å›ç»“æœå¤šä¸ªç‰ˆæœ¬åˆå¹¶
        recall_list = []
        try:

            data = self.hbu.get_table_cells(table_name, key_format, column_format)
            for _ in data:
                recall_list = list(set(recall_list).union(set(eval(_))))

            # è¯»å–æ‰€æœ‰è¿™ä¸ªç”¨æˆ·çš„åœ¨çº¿æ¨èçš„ç‰ˆæœ¬ï¼Œæ¸…ç©ºè¯¥é¢‘é“çš„æ•°æ®
            # self.hbu.get_table_delete(table_name, key_format, column_format)
        except Exception as e:
            logger.warning(
                &quot;{} WARN read recall data exception:{}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
        return recall_list

    def read_redis_new_data(self, channel_id):
        &quot;&quot;&quot;è·å–redisæ–°æ–‡ç« ç»“æœ
        :param channel_id:
        :return:
        &quot;&quot;&quot;
        # formatç»“æœ
        logger.info(&quot;{} INFO read channel:{} new recommend data&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), channel_id))
        _key = &quot;ch:{}:new&quot;.format(channel_id)
        try:
            res = self.client.zrevrange(_key, 0, -1)
        except redis.exceptions.ResponseError as e:
            logger.warning(&quot;{} WARN read new article exception:{}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
            res = []
        return list(map(int, res))

    def read_redis_hot_data(self, channel_id):
        &quot;&quot;&quot;è·å–redisçƒ­é—¨æ–‡ç« ç»“æœ
        :param channel_id:
        :return:
        &quot;&quot;&quot;
        # formatç»“æœ
        logger.info(&quot;{} INFO read channel:{} hot recommend data&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), channel_id))
        _key = &quot;ch:{}:hot&quot;.format(channel_id)
        try:
            _res = self.client.zrevrange(_key, 0, -1)
        except redis.exceptions.ResponseError as e:
            logger.warning(&quot;{} WARN read hot article exception:{}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
            _res = []
        # æ¯æ¬¡è¿”å›å‰50çƒ­é—¨æ–‡ç« 
        res = list(map(int, _res))
        if len(res) &gt; 50:
            res = res[:50]
        return res

    def read_hbase_article_similar(self, table_name, key_format, article_num):
        &quot;&quot;&quot;è·å–æ–‡ç« ç›¸ä¼¼ç»“æœ
        :param article_id: æ–‡ç« id
        :param article_num: æ–‡ç« æ•°é‡
        :return:
        &quot;&quot;&quot;
        # ç¬¬ä¸€ç§è¡¨ç»“æ„æ–¹å¼æµ‹è¯•ï¼š
        # create 'article_similar', 'similar'
        # put 'article_similar', '1', 'similar:1', 0.2
        # put 'article_similar', '1', 'similar:2', 0.34
        try:
            _dic = self.hbu.get_table_row(table_name, key_format)

            res = []
            _srt = sorted(_dic.items(), key=lambda obj: obj[1], reverse=True)
            if len(_srt) &gt; article_num:
                _srt = _srt[:article_num]
            for _ in _srt:
                res.append(int(_[0].decode().split(':')[1]))
        except Exception as e:
            logger.error(&quot;{} ERROR read similar article exception: {}&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), e))
            res = []
        return res


if __name__ == '__main__':

    rr = ReadRecall()
    print(rr.read_hbase_article_similar('article_similar', b'13342', 10))
    print(rr.read_hbase_recall_data('cb_recall', b'recall:user:1115629498121846784', b'als:18'))

    # rr = ReadRecall()
    # print(rr.read_redis_new_data(18))
</code></pre>
<h1 id="æ¨èä¸­å¿ƒ-è·å–å¤šè·¯å¬å›ç»“æœè¿‡æ»¤å†å²æ¨èè®°å½•é€»è¾‘">æ¨èä¸­å¿ƒ---è·å–å¤šè·¯å¬å›ç»“æœï¼Œè¿‡æ»¤å†å²æ¨èè®°å½•é€»è¾‘</h1>
<ul>
<li>ç›®çš„ï¼š
<ul>
<li>åœ¨æ¨èä¸­åŠ å…¥å¬å›æ–‡ç« ç»“æœä»¥åŠè¿‡æ»¤é€»è¾‘</li>
<li>æŠŠä¹‹å‰çš„æ¨èä¸­å¿ƒçš„ä¸šåŠ¡ä¸­çš„ ï¼ˆå¬å›ï¼‰ç”¨åˆšåšå¥½çš„å¬å›é›†å¡«è¡¥ä¸Šï¼ˆå¹¶ä¸”ï¼‰</li>
</ul>
</li>
<li>æ­¥éª¤ï¼š
<ul>
<li>1ã€å¾ªç¯ç®—æ³•ç»„åˆå‚æ•°ï¼Œéå†ä¸åŒå¬å›ç»“æœè¿›è¡Œè¿‡æ»¤</li>
<li>2ã€è¿‡æ»¤å½“å‰è¯¥è¯·æ±‚é¢‘é“æ¨èå†å²ç»“æœï¼Œéœ€è¦è¿‡æ»¤0é¢‘é“æ¨èç»“æœï¼Œé˜²æ­¢å‡ºç°æ¨èé¢‘é“ä¸25ä¸ªé¢‘é“æœ‰é‡å¤æ¨è</li>
<li>3ã€è¿‡æ»¤ä¹‹åï¼Œæ¨èå‡ºå»æŒ‡å®šä¸ªæ•°çš„æ–‡ç« åˆ—è¡¨ï¼Œå†™å…¥å†å²è®°å½•ï¼Œå‰©ä¸‹å¤šçš„å†™å…¥å¾…æ¨èç»“æœ</li>
</ul>
</li>
</ul>
<h2 id="1-å¾ªç¯ç®—æ³•ç»„åˆå‚æ•°éå†ä¸åŒå¬å›ç»“æœè¿›è¡Œè¿‡æ»¤">1. å¾ªç¯ç®—æ³•ç»„åˆå‚æ•°ï¼Œéå†ä¸åŒå¬å›ç»“æœè¿›è¡Œè¿‡æ»¤</h2>
<p>å®šä¹‰ä¸€ä¸ªuser_reco_listå‡½æ•°ä¸­å®ç°è¯»å–ç”¨æˆ·çš„å¬å›ç»“æœï¼Œ</p>
<pre><code># æ‰€æœ‰åˆå¹¶çš„ç»“æœ
        reco_set = []
        # -  1ã€å¾ªç¯ç®—æ³•ç»„åˆå‚æ•°ï¼Œéå†ä¸åŒå¬å›ç»“æœåˆå¹¶ï¼Œ18
        for _num in RAParam.COMBINE[temp.algo][1]:
            if _num == 103:
                # è¯»å–æ–°æ–‡ç« çš„ç»“æœï¼Œtemp.channel_id
                _res = self.recall_service.read_redis_new_article(temp.channel_id)
                reco_set = list(set(reco_set).union(set(_res)))
            elif _num == 104:
                # è¯»å–çƒ­é—¨æ–‡ç« çš„æ•°æ®
                _res = self.recall_service.read_redis_hot_article(temp.channel_id)
                reco_set = list(set(reco_set).union(set(_res)))
            else:
                # è¯»å–å…·ä½“ç¼–å·çš„å¯¹åº”è¡¨cb_recall,å¯¹åº”å¬å›ç®—æ³•çš„å¬å›ç»“æœals, content, online
                _res = self.recall_service.\
                    read_hbase_recall_data(RAParam.RECALL[_num][0],
                                        'recall:user:{}'.format(temp.user_id).encode(),
                                        '{}:{}'.format(RAParam.RECALL[_num][1], temp.channel_id).encode())
                reco_set = list(set(reco_set).union(set(_res)))
</code></pre>
<h2 id="2-è¿‡æ»¤å½“å‰è¯¥è¯·æ±‚é¢‘é“æ¨èå†å²ç»“æœ">2. è¿‡æ»¤å½“å‰è¯¥è¯·æ±‚é¢‘é“æ¨èå†å²ç»“æœ</h2>
<p>å¦‚æœä¸æ˜¯0é¢‘é“éœ€è¦è¿‡æ»¤0é¢‘é“æ¨èç»“æœï¼Œé˜²æ­¢å‡ºç°ï¼Œ æ¯”å¦‚Pythoné¢‘é“å’Œ0é¢‘é“ç›¸åŒçš„æ¨èç»“æœ</p>
<pre><code># - 2ã€è¿‡æ»¤ï¼Œè¯¥è¯·æ±‚é¢‘é“(18)çš„å†å²æ¨èè®°å½•è¿‡æ»¤ï¼‰ï¼Œæ¨èé¢‘é“0é¢‘é“
# - 0ï¼šAPP  æ¨è(å¾ªç¯æ‰€æœ‰çš„é¢‘é“å¬å›ç»“æœ)ï¼Œ0 é¢‘é“ä¹Ÿæœ‰å†å²è®°å½•
# temp.channel_idé¢‘é“è¿™ä¸ªç”¨æˆ·å†å²è®°å½•è¿›è¡Œè¿‡æ»¤
history_list = []

try:
    data = self.hbu.get_table_cells('history_recommend',
                                    'reco:his:{}'.format(temp.user_id).encode(),
                                    'channel:{}'.format(temp.channel_id).encode())
    for _ in data:
        history_list = list(set(history_list).union(set(eval(_))))

    logger.info(&quot;{} INFO read user_id:{} channel_id:{} history data&quot;.format(
        datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

except Exception as e:
    # æ‰“å°æ—¥å¿—
    logger.warning(
        &quot;{} WARN filter history article exception:{}&quot;.format(datetime.now().
                                                                strftime('%Y-%m-%d %H:%M:%S'), e))
# è·å–0é¢‘é“çš„ç»“æœ
try:
    data = self.hbu.get_table_cells('history_recommend',
                                    'reco:his:{}'.format(temp.user_id).encode(),
                                    'channel:{}'.format(0).encode())
    for _ in data:
        history_list = list(set(history_list).union(set(eval(_))))
    logger.info(&quot;{} INFO filter user_id:{} channel:{} history data&quot;.format(
        datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, 0))

except Exception as e:
    logger.warning(
        &quot;{} WARN filter history article exception:{}&quot;.format(datetime.now().
                                                                strftime('%Y-%m-%d %H:%M:%S'), e))

reco_set = list(set(reco_set).difference(set(history_list)))
</code></pre>
<h2 id="3-è¿‡æ»¤åæ¨èå‡ºå»æŒ‡å®šä¸ªæ•°çš„æ–‡ç« åˆ—è¡¨">3. è¿‡æ»¤åï¼Œæ¨èå‡ºå»æŒ‡å®šä¸ªæ•°çš„æ–‡ç« åˆ—è¡¨</h2>
<p>å†™å…¥å†å²è®°å½•ï¼Œå‰©ä¸‹å¤šçš„å†™å…¥å¾…æ¨èç»“æœ</p>
<pre><code># - 4ã€è¿”å›ç»“æœï¼š
if not reco_set:
    return reco_set
else:
    # - å¦‚æœæœ‰æ•°æ®ï¼Œå°äºéœ€è¦æ¨èæ–‡ç« çš„æ•°é‡Nä¹‹åï¼Œæ”¾å…¥å†å²æ¨èè®°å½•ä¸­history_recommendï¼Œè¿”å›ç»“æœç»™ç”¨
    if len(reco_set) &lt;= temp.article_num:
        res = reco_set
    else:
        #   - å¦‚æœæœ‰ï¼Œ350ç¯‡ï¼Œå–å‡ºNä¸ªï¼Œè¿›è¡Œè¿”å›æ¨èï¼Œæ”¾å…¥å†å²è®°å½•history_recommend
        #     - (350- N)ä¸ªæ–‡ç« ï¼Œæ”¾å…¥wait_recommend
        res = reco_set[:temp.article_num]

        logger.info(
            &quot;{} INFO put user_id:{} channel:{} wait data&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

        # æ”¾å…¥å‰©ä¸‹å¤šä½™çš„æ•°æ®åˆ°wait_recommendå½“ä¸­
        self.hbu.get_table_put('wait_recommend',
                                'reco:{}'.format(temp.user_id).encode(),
                                'channel:{}'.format(temp.channel_id).encode(),
                                str(reco_set[temp.article_num:]).encode(),
                                timestamp=temp.time_stamp)

    # æ”¾å…¥å†å²è®°å½•
    self.hbu.get_table_put('history_recommend',
                            'reco:his:{}'.format(temp.user_id).encode(),
                            'channel:{}'.format(temp.channel_id).encode(),
                            str(res).encode(),
                            timestamp=temp.time_stamp)
    # æ”¾å…¥å†å²è®°å½•æ—¥å¿—
    logger.info(
        &quot;{} INFO store recall/sorted user_id:{} channel:{} history_recommend data&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

    return res
</code></pre>
<h2 id="ä¿®æ”¹è°ƒç”¨è¯»å–å¬å›æ•°æ®çš„éƒ¨åˆ†">ä¿®æ”¹è°ƒç”¨è¯»å–å¬å›æ•°æ®çš„éƒ¨åˆ†</h2>
<pre><code># 2ã€ä¸å¼€å¯ç¼“å­˜
res = self.user_reco_list(temp)
temp.time_stamp = int(last_stamp)
track = add_track(res, temp)
</code></pre>
<h2 id="è¿è¡ŒgrpcæœåŠ¡ä¹‹åæµ‹è¯•ç»“æœ">è¿è¡ŒgrpcæœåŠ¡ä¹‹åï¼Œæµ‹è¯•ç»“æœ</h2>
<pre><code>hbase(main):007:0&gt; get &quot;history_recommend&quot;, 'reco:his:1115629498121846784', {COLUMN=&gt;'channel:18',VERSIONS=&gt;1000}
COLUMN                     CELL                                                                        
channel:18                timestamp=1558189615378, value=[13890, 14915, 13891, 15429, 15944, 44371, 18
                        005, 15196, 13410, 13672]                                                   
channel:18                timestamp=1558189317342, value=[17966, 17454, 14125, 16174, 14899, 44339, 16
                        437, 18743, 44090, 18238]                                                   
channel:18                timestamp=1558143073173, value=[19200, 17665, 16151, 16411, 19233, 13090, 15
                        140, 16421, 19494, 14381]
</code></pre>
<p>å¾…æ¨èè¡¨ä¸­æœ‰</p>
<pre><code>hbase(main):008:0&gt; scan 'wait_recommend'
ROW                        COLUMN+CELL                                                                 
reco:1115629498121846784  column=channel:18, timestamp=1558189615378, value=[44137, 18795, 19052, 4465
                        2, 44654, 44657, 14961, 17522, 43894, 44412, 16000, 14208, 44419, 17802, 142
                        23, 18836, 140956, 18335, 13728, 14498, 44451, 44456, 18609, 18353, 44468, 1
                        8103, 135869, 16062, 14015, 13757, 13249, 44483, 17605, 14021, 15309, 18127,
                            43983, 44754, 43986, 19413, 14805, 18904, 44761, 17114, 13272, 14810, 18907
                        , 13022, 14300, 17120, 17632, 14299, 43997, 17889, 17385, 18156, 15085, 1329
                        5, 44020, 14839, 44024, 14585, 18172, 44541]
</code></pre>
<h2 id="å®Œæ•´ä»£ç -2">å®Œæ•´ä»£ç </h2>
<pre><code>def user_reco_list(self, temp):
    &quot;&quot;&quot;
    è·å–ç”¨æˆ·çš„å¬å›ç»“æœè¿›è¡Œæ¨è
    :param temp:
    :return:
    &quot;&quot;&quot;
    reco_set = []
    # 1ã€å¾ªç¯ç®—æ³•ç»„åˆå‚æ•°ï¼Œéå†ä¸åŒå¬å›ç»“æœè¿›è¡Œè¿‡æ»¤
    for _num in RAParam.COMBINE[temp.algo][1]:
        # è¿›è¡Œæ¯ä¸ªå¬å›ç»“æœçš„è¯»å–100,101,102,103,104
        if _num == 103:
            # æ–°æ–‡ç« å¬å›è¯»å–
            _res = self.recall_service.read_redis_new_article(temp.channel_id)
            reco_set = list(set(reco_set).union(set(_res)))
        elif _num == 104:
            # çƒ­é—¨æ–‡ç« å¬å›è¯»å–
            _res = self.recall_service.read_redis_hot_article(temp.channel_id)
            reco_set = list(set(reco_set).union(set(_res)))
        else:
            _res = self.recall_service.\
                read_hbase_recall_data(RAParam.RECALL[_num][0],
                                       'recall:user:{}'.format(temp.user_id).encode(),
                                       '{}:{}'.format(RAParam.RECALL[_num][1], temp.channel_id).encode())
            # è¿›è¡Œåˆå¹¶æŸä¸ªååŒè¿‡æ»¤å¬å›çš„ç»“æœ
            reco_set = list(set(reco_set).union(set(_res)))

    # reco_setéƒ½æ˜¯æ–°æ¨èçš„ç»“æœï¼Œè¿›è¡Œè¿‡æ»¤
    history_list = []
    try:
        data = self.hbu.get_table_cells('history_recommend',
                                        'reco:his:{}'.format(temp.user_id).encode(),
                                        'channel:{}'.format(temp.channel_id).encode())
        for _ in data:
            history_list = list(set(history_list).union(set(eval(_))))

        logger.info(&quot;{} INFO filter user_id:{} channel:{} history data&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
    except Exception as e:
        logger.warning(
            &quot;{} WARN filter history article exception:{}&quot;.format(datetime.now().
                                                                 strftime('%Y-%m-%d %H:%M:%S'), e))

    # å¦‚æœ0å·é¢‘é“æœ‰å†å²è®°å½•ï¼Œä¹Ÿéœ€è¦è¿‡æ»¤

    try:
        data = self.hbu.get_table_cells('history_recommend',
                                        'reco:his:{}'.format(temp.user_id).encode(),
                                        'channel:{}'.format(0).encode())
        for _ in data:
            history_list = list(set(history_list).union(set(eval(_))))

        logger.info(&quot;{} INFO filter user_id:{} channel:{} history data&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, 0))
    except Exception as e:
        logger.warning(
            &quot;{} WARN filter history article exception:{}&quot;.format(datetime.now().
                                                                 strftime('%Y-%m-%d %H:%M:%S'), e))

    # è¿‡æ»¤æ“ä½œ reco_set ä¸history_listè¿›è¡Œè¿‡æ»¤
    reco_set = list(set(reco_set).difference(set(history_list)))

    # æ’åºä»£ç é€»è¾‘
    # _sort_num = RAParam.COMBINE[temp.algo][2][0]
    # reco_set = sort_dict[RAParam.SORT[_sort_num]](reco_set, temp, self.hbu)

    # å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œç›´æ¥è¿”å›
    if not reco_set:
        return reco_set
    else:

        # ç±»å‹è¿›è¡Œè½¬æ¢
        reco_set = list(map(int, reco_set))

        # è·Ÿåç«¯éœ€è¦æ¨èçš„æ–‡ç« æ•°é‡è¿›è¡Œæ¯”å¯¹ article_num
        # article_num &gt; reco_set
        if len(reco_set) &lt;= temp.article_num:
            res = reco_set
        else:
            # ä¹‹å–å‡ºæ¨èå‡ºå»çš„å†…å®¹
            res = reco_set[:temp.article_num]
            # å‰©ä¸‹çš„æ¨èç»“æœæ”¾å…¥wait_recommendç­‰å¾…ä¸‹æ¬¡å¸…æ–°çš„æ—¶å€™ç›´æ¥æ¨è
            self.hbu.get_table_put('wait_recommend',
                                   'reco:{}'.format(temp.user_id).encode(),
                                   'channel:{}'.format(temp.channel_id).encode(),
                                   str(reco_set[temp.article_num:]).encode(),
                                   timestamp=temp.time_stamp)
            logger.info(
                &quot;{} INFO put user_id:{} channel:{} wait data&quot;.format(
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

        # æ”¾å…¥å†å²è®°å½•è¡¨å½“ä¸­
        self.hbu.get_table_put('history_recommend',
                               'reco:his:{}'.format(temp.user_id).encode(),
                               'channel:{}'.format(temp.channel_id).encode(),
                               str(res).encode(),
                               timestamp=temp.time_stamp)
        # æ”¾å…¥å†å²è®°å½•æ—¥å¿—
        logger.info(
            &quot;{} INFO store recall/sorted user_id:{} channel:{} history_recommend data&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

        return res</code></pre>

                </div>
                <div class="clear"></div>
              </section>
            </article>
            <div class="clear"></div>

            <section class="related section">
              
              <article class="prev grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://cythonlin.github.io/media/images/XH05Gb5J6.jpg');"></div>
                 <a href="https://cythonlin.github.io/post/go-greater-fu-xi/" class="full-link"></a>
                 <div class="info">
                  <time datetime="2021-02-25">2021-02-25</time>
                  <h4 class="title white no-margin">RS =&gt; æ¨èç³»ç»Ÿï¼ˆå…­ï¼‰æ¨èç¼“å­˜æœåŠ¡+LR</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://cythonlin.github.io/media/images/left-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              
              
              <article class="next grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://cythonlin.github.io/media/images/sKPdrpV6Y.jpg');"></div>
                 <a href="https://cythonlin.github.io/post/pr-greater-powershell-7/" class="full-link"></a>
                 <div class="info">
                  <time datetime="2021-02-18">2021-02-18</time>
                  <h4 class="title white no-margin">PR =&gt; Pshell7+cheat.sh</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://cythonlin.github.io/media/images/right-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              

                <div class="clear"></div>
            </section>

              <div class="clear"></div>
              
            
<!--               <div id="comments" class="bg-white hosted ">
                <p>è¯·åˆ°å®¢æˆ·ç«¯â€œä¸»é¢˜--è‡ªå®šä¹‰é…ç½®--valineâ€ä¸­å¡«å…¥IDå’ŒKEY</p>
              </div> -->
              <div class="clear"></div>
            

            </div>
          </div>
      </main>

          <footer id="footer" class="grid-container">
        <div class="widgets row gradient-effect">
            <div class="default-sidebar border-effect">
              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_epcl_posts_thumbs underline-effect">
                  <h4 class="widget-title title white bordered">æœ€æ–°æ–‡ç« </h4>
                  
                  
                  <article class="item post-0 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://cythonlin.github.io/post/ide-greater-my-sublimepy/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('/media/images/gridea.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2021-03-03">2021-03-03</time>
                      <h4 class="title usmall">
                        <a href="https://cythonlin.github.io/post/ide-greater-my-sublimepy/">IDE =&gt; My Sublimeï¼ˆPYï¼‰</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-1 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://cythonlin.github.io/post/rs-greater-9/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('/media/images/gridea.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2021-03-03">2021-03-03</time>
                      <h4 class="title usmall">
                        <a href="https://cythonlin.github.io/post/rs-greater-9/"> IDE =&gt; My Pycharm</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-2 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://cythonlin.github.io/post/rs-greater-8/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('/media/images/gridea.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2021-03-03">2021-03-03</time>
                      <h4 class="title usmall">
                        <a href="https://cythonlin.github.io/post/rs-greater-8/">RS =&gt; 8</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_tag_cloud underline-effect">
                  <h4 class="widget-title title white bordered">æ ‡ç­¾äº‘</h4>
                  <div class="tagcloud">
                    
                      <a href="https://cythonlin.github.io/tag/c137hZpK4/" class="ctag ctag-0 ctag-c137hZpK4" aria-label="">IDE</a>
                    
                      <a href="https://cythonlin.github.io/tag/wAXYBHxvH/" class="ctag ctag-1 ctag-wAXYBHxvH" aria-label="">Python</a>
                    
                      <a href="https://cythonlin.github.io/tag/EjFvvnhFs/" class="ctag ctag-2 ctag-EjFvvnhFs" aria-label="">RS</a>
                    
                      <a href="https://cythonlin.github.io/tag/XH05Gb5J6/" class="ctag ctag-3 ctag-XH05Gb5J6" aria-label="">Golang</a>
                    
                      <a href="https://cythonlin.github.io/tag/sKPdrpV6Y/" class="ctag ctag-4 ctag-sKPdrpV6Y" aria-label="">PR</a>
                    
                      <a href="https://cythonlin.github.io/tag/1L4lr0i2f/" class="ctag ctag-5 ctag-1L4lr0i2f" aria-label="">Docker</a>
                    
                      <a href="https://cythonlin.github.io/tag/n16me-6oV/" class="ctag ctag-6 ctag-n16me-6oV" aria-label="">AI</a>
                    
                      <a href="https://cythonlin.github.io/tag/FLS_eF6Eg/" class="ctag ctag-7 ctag-FLS_eF6Eg" aria-label="">KG</a>
                    
                      <a href="https://cythonlin.github.io/tag/sJAb6NuUK/" class="ctag ctag-8 ctag-sJAb6NuUK" aria-label="">DB</a>
                    
                  </div>
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="epcl_about-2" class="widget widget_epcl_about underline-effect">
                  <h4 class="widget-title title white bordered">å…³äºæˆ‘</h4>
                  <div class="avatar">
                    <a href="" class="translate-effect thumb"><span class="fullimage cover" style="background-image: url(https://cythonlin.github.io/images/avatar.png);"></span></a>
                  </div>
                  <div class="info">
                    <h4 class="title small author-name gradient-effect no-margin"><a href="">Cython_lin</a></h4>
                    <p class="founder"></p>
                    <div class="social">
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                    </div> 
                  </div>
                  <div class="clear"></div>
                  </section>
              </div>

            </div>
            <div class="clear"></div>
        </div>

        <div class="logo">
          <a href="https://cythonlin.github.io"><img src="\media\images\custom-footerLogo.png" alt=""></a>
        </div>
        <p class="published border-effect">
          Â©2019 å…± 78 ç¯‡æ–‡ç« 
          <br/>

        </p>
        
        <a href="javascript:void(0)" id="back-to-top" class="epcl-button dark" style="display:none">
          <i class="fa fa-arrow"></i>
        </a>
    </footer>
    
    <div class="clear"></div>

        

      
    <script src="https://cythonlin.github.io/media/js/functions-post.js"></script>

    </div>
    <!-- end: #wrapper -->
  </body>
</html>
