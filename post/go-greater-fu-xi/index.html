<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RS =&gt; æ¨èç³»ç»Ÿï¼ˆå…­ï¼‰æ¨èç¼“å­˜æœåŠ¡+LR | Cython_lin</title>
<meta name="description" content="" />
<link rel="shortcut icon" href="https://cythonlin.github.io/favicon.ico">
<link rel="stylesheet" href="https://cythonlin.github.io/styles/main.css">

<script src="https://cythonlin.github.io/media/js/jquery.min.js"></script>
<script src="https://cythonlin.github.io/media/js/masonry.pkgd.min.js"></script>
<script src="https://cythonlin.github.io/media/js/aos.js"></script>
<script src="https://cythonlin.github.io/media/js/pace.min.js"></script>
<script src="https://cythonlin.github.io/media/js/view-image.min.js"></script>
<script src="https://cythonlin.github.io/media/js/jquery.magnific-popup.min.js"></script>
<script src="https://cythonlin.github.io/media/js/functions.js"></script>
    <meta name="referrer" content="never">
    <meta name="description" content="å¾…æ¨èç»“æœçš„redisç¼“å­˜

ç›®çš„ï¼š

å¯¹å¾…æ¨èç»“æœè¿›è¡ŒäºŒçº§ç¼“å­˜ï¼Œå¤šçº§ç¼“å­˜å‡å°‘æ•°æ®åº“è¯»å–å‹åŠ›


æ­¥éª¤ï¼š

è·å–redisç»“æœï¼Œè¿›è¡Œåˆ¤æ–­

å¦‚æœredisæœ‰

è¯»å–éœ€è¦æ¨èçš„æ–‡ç« æ•°é‡æ”¾å›ï¼Œå¹¶åˆ é™¤è¿™äº›æ–‡ç« ï¼Œå¹¶ä¸”æ”¾å…¥æ¨èå†å²æ¨èç»“æœä¸­


å¦‚æœ..." />
    <meta name="keywords" content="Golang" />
    <script src="https://cythonlin.github.io/media/js/waterfall.min.js"></script>
    <script src="https://cythonlin.github.io/media/js/prism.min.js"></script>
  </head>
  <body>
            <header id="header" class="grid-container">
        <!-- start: .menu-wrapper -->
        <div class="menu-mobile"> 
          <i class="fa fa-reorder"></i>
        </div>
        <div class="menu-wrapper">
          <div class="">
            <div class="logo">
              <a href="https://cythonlin.github.io"><img src="\media\images\custom-headerLogo.png" alt=""></a>
            </div>
            <!-- start: .main-nav -->

            <nav class="main-nav grid-container grid-parent">
              <ul id="menu-header" class="menu gradient-effect">
                <li class=""><a href="https://cythonlin.github.io" class="menu">é¦–é¡µ</a></li>
                
                  <li class="" >
                    <a href="/archives" class="menu">
                      å½’æ¡£
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="/tags" class="menu">
                      æ ‡ç­¾
                    </a>
                  </li>
                
                  <li class="" >
                    <a href="https://cythonlin.github.io/post/the-future-is-promising" class="menu">
                      å…³äº
                    </a>
                  </li>
                
                <li class="search-menu-item hide-on-mobile hide-on-tablet"><a href="#search-lightbox" class="lightbox mfp-inline"><i class="fa fa-search-line"></i></a></li>
              </ul>
            </nav>
            <a href="#search-lightbox" class="lightbox epcl-search-button mfp-inline hide-on-tablet hide-on-desktop"><i class="fa fa-search-line"></i></a>
            <!-- end: .main-nav -->
            <div class="clear"></div>
            <div class="border hide-on-tablet hide-on-mobile"></div>
          </div>    
          <div class="clear"></div>
        </div>
        <!-- end: .menu-wrapper -->
        <div class="clear"></div>
      </header>
      <div class="hide-on-mobile hide-on-tablet hide-on-desktop">
        <div id="search-lightbox" class="grid-container grid-small grid-parent mfp-hide">
          <div class="search-wrapper section">
            <form id="gridea-search-form" data-update="1615789667564" action="/search/index.html" class="search-form" _lpchecked="1">
              <input type="text" name="q" id="s" value="" class="search-field" placeholder="æœç‚¹å•¥..." aria-label="æœç‚¹å•¥..." required="">
              <button type="submit" class="submit" aria-label="Submit">
                <i class="fa fa-search-line"></i>
              </button>
            </form>
          </div>
        </div>
      </div>

      <main id="single" class="main grid-container fullcover no-sidebar aos-init aos-animate" data-aos="fade">

        <div class="center content">
          <div class="featured-image cover" style="background-image: url('/media/images/gridea.jpg');">
            <div class="meta top"> 
              <time class="meta-info" style="float:left;" datetime="2021-02-25"><i class="fa fa-calendar"></i><span class="lately">18 å¤©å‰</span></time>
              
              <a href="https://cythonlin.github.io/post/go-greater-fu-xi/#comments" class="comments meta-info" title="">
                <i class="fa fa-comment remixicon"></i><span class="comment-count valine-comment-count" data-xid="/go-greater-fu-xi/"> </span>
              </a>
              <span id="/go-greater-fu-xi/" class="leancloud_visitors views-counter meta-info" title=""><i class="fa fa-leancloud remixicon"></i><span class="leancloud-visitors-count"></span></span>
              
            </div>
            <div class="info">
              <div class="tags ">
                
                      <a href="https://cythonlin.github.io/tag/XH05Gb5J6/" class="ctag ctag-0 ctag-XH05Gb5J6" aria-label="">Golang</a>
                    
              </div>
              <h1 class="title ularge white bold">RS =&gt; æ¨èç³»ç»Ÿï¼ˆå…­ï¼‰æ¨èç¼“å­˜æœåŠ¡+LR</h1>
            </div>
          </div>
        </div>  

        <div class="epcl-page-wrapper">
          <div class="left-content grid-70 np-mobile">
            <article class="main-article post">
              <section class="post-content">
                <div class="text">
                  <h1 id="å¾…æ¨èç»“æœçš„redisç¼“å­˜">å¾…æ¨èç»“æœçš„redisç¼“å­˜</h1>
<ul>
<li>ç›®çš„ï¼š
<ul>
<li>å¯¹å¾…æ¨èç»“æœè¿›è¡ŒäºŒçº§ç¼“å­˜ï¼Œå¤šçº§ç¼“å­˜å‡å°‘æ•°æ®åº“è¯»å–å‹åŠ›</li>
</ul>
</li>
<li>æ­¥éª¤ï¼š
<ul>
<li>è·å–redisç»“æœï¼Œè¿›è¡Œåˆ¤æ–­
<ul>
<li>å¦‚æœredisæœ‰
<ul>
<li>è¯»å–éœ€è¦æ¨èçš„æ–‡ç« æ•°é‡æ”¾å›ï¼Œå¹¶åˆ é™¤è¿™äº›æ–‡ç« ï¼Œå¹¶ä¸”æ”¾å…¥æ¨èå†å²æ¨èç»“æœä¸­</li>
</ul>
</li>
<li>å¦‚æœrediså½“ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä»wait_recommendä¸­è¯»å–
<ul>
<li>å¦‚æœwait_recommendä¸­ä¹Ÿæ²¡æœ‰ï¼Œç›´æ¥è¿”å›</li>
<li>å¦‚æœwait_recommendæœ‰ï¼Œä»wait_recommendå–å‡ºæ‰€æœ‰ç»“æœï¼Œå®šä¸€ä¸ªæ•°é‡(å¦‚100ç¯‡)å­˜å…¥redis,å‰©ä¸‹æ”¾å›wait_recommend,ä¸å¤Ÿ100ï¼Œå…¨éƒ¨æ”¾å…¥redisï¼Œç„¶åæ¸…ç©ºwait_recommend
<ul>
<li>ä»redisä¸­æ‹¿å‡ºè¦æ¨èçš„æ–‡ç« ç»“æœï¼Œç„¶åæ”¾å…¥å†å²æ¨èç»“æœä¸­</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¢åŠ ä¸€ä¸ªç¼“å­˜æ•°æ®åº“</p>
<pre><code># ç¼“å­˜åœ¨8å·å½“ä¸­
cache_client = redis.StrictRedis(host=DefaultConfig.REDIS_HOST,
                                port=DefaultConfig.REDIS_PORT,
                                db=8,
                                decode_responses=True)
</code></pre>
<p>redis 8 å·æ•°æ®åº“è¯»å–</p>
<pre><code># ç›´æ¥å»redisæ‹¿å–å¯¹åº”çš„é”®ï¼Œå¦‚æœä¸ºç©º
# é¦–å…ˆä»è·å–redisç»“æœï¼Œè¿›è¡Œåˆ¤æ–­(ç¼“å­˜æ‹¿)
    key = 'reco:{}:{}:art'.format(temp.user_id, temp.channel_id)
    res = cache_client.zrevrange(key, 0, temp.article_num - 1)
    # å¦‚æœredisæœ‰ï¼Œè¯»å–éœ€è¦æ¨èçš„æ–‡ç« æ•°é‡æ”¾å›ï¼Œå¹¶åˆ é™¤è¿™äº›æ–‡ç« ï¼Œå¹¶ä¸”æ”¾å…¥æ¨èå†å²æ¨èç»“æœä¸­
    if res:
        cache_client.zrem(key, *res)

    # å¦‚æœredisæ²¡æœ‰æ•°æ®ï¼Œè¿›è¡Œwait_recommendè¯»å–ï¼Œæ”¾å…¥redisä¸­

    # åˆ é™¤redisè¿™ä¸ªé”®
    cache_client.delete(key)
    try:
        # å­—ç¬¦ä¸²å˜æˆåˆ—è¡¨
        hbase_cache = eval(hbu.get_table_row('wait_recommend',
                                             'reco:{}'.format(temp.user_id).encode(),
                                             'channel:{}'.format(temp.channel_id).encode()))

    except Exception as e:
        logger.warning(&quot;{} WARN read user_id:{} wait_recommend exception:{} not exist&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, e))

        hbase_cache = []
    if not hbase_cache:
        #  å¦‚æœwait_recommendä¸­ä¹Ÿæ²¡æœ‰ï¼Œç›´æ¥è¿”å›ç©ºï¼Œå»è¿›è¡Œä¸€æ¬¡å¬å›è¯»å–ã€æ’åºç„¶åæ¨è
        return hbase_cache
    # wait_recommendæœ‰ï¼Œä»wait_recommendå–å‡ºæ‰€æœ‰ç»“æœï¼Œå®šä¸€ä¸ªæ•°é‡(å¦‚100ç¯‡)çš„æ–‡ç« å­˜å…¥redis
    if len(hbase_cache) &gt; 100:
        logger.info(
            &quot;{} INFO reduce user_id:{} channel:{} wait_recommend data&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
        # æ‹¿å‡ºå›ºå®šæ•°é‡ï¼ˆ100ï¼‰ç»™redis
        cache_redis = hbase_cache[:100]
        # æ”¾å…¥redisç¼“å­˜
        cache_client.zadd(key, dict(zip(cache_redis, range(len(cache_redis)))))
        # å‰©ä¸‹çš„æ”¾å›wait hbaseç»“æœ
        hbu.get_table_put('wait_recommend',
                          'reco:{}'.format(temp.user_id).encode(),
                          'channel:{}'.format(temp.channel_id).encode(),
                          str(hbase_cache[100:]).encode())
    else:
        logger.info(
            &quot;{} INFO delete user_id:{} channel:{} wait_recommend data&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
        # - wait_recommendä¸å¤Ÿä¸€å®šæ•°é‡ï¼Œå…¨éƒ¨å–å‡ºæ”¾å…¥rediså½“ä¸­ï¼Œç›´æ¥æ¨èå‡ºå»
        # æ¸…ç©ºwait_recommend
        hbu.get_table_put('wait_recommend',
                          'reco:{}'.format(temp.user_id).encode(),
                          'channel:{}'.format(temp.channel_id).encode(),
                          str([]).encode())

        # æ”¾å…¥redisç¼“å­˜
        cache_client.zadd(key, dict(zip(hbase_cache, range(len(hbase_cache)))))

    res = cache_client.zrevrange(key, 0, temp.article_num - 1)
    if res:
        cache_client.zrem(key, *res)
</code></pre>
<p>æ¨èå‡ºå»çš„ç»“æœæ”¾å…¥å†å²ç»“æœ</p>
<pre><code># è¿›è¡Œç±»å‹è½¬æ¢
    res = list(map(int, res))
    logger.info(&quot;{} INFO get cache data and store user_id:{} channel:{} cache history data&quot;.format(
        datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

    # æ”¾å…¥å†å²è®°å½•
    hbu.get_table_put('history_recommend',
                    'reco:his:{}'.format(temp.user_id).encode(),
                    'channel:{}'.format(temp.channel_id).encode(),
                    str(res).encode(),
                    timestamp=temp.time_stamp)
    return res
</code></pre>
<p>å®Œæ•´é€»è¾‘ä»£ç ï¼š</p>
<pre><code>from server import cache_client
import logging
from datetime import datetime

logger = logging.getLogger('recommend')


def get_cache_from_redis_hbase(temp, hbu):
    &quot;&quot;&quot;
    è¿›è¡Œç”¨æˆ·é¢‘é“æ¨èç¼“å­˜ç»“æœçš„è¯»å–
    :param temp: ç”¨æˆ·è¯·æ±‚çš„å‚æ•°
    :param hbu: hbaseå·¥å…·
    :return:
    &quot;&quot;&quot;

    # - é¦–å…ˆä»è·å–redisç»“æœï¼Œè¿›è¡Œåˆ¤æ–­(ç¼“å­˜æ‹¿)
    key = 'reco:{}:{}:art'.format(temp.user_id, temp.channel_id)
    res = cache_client.zrevrange(key, 0, temp.article_num - 1)
    # - å¦‚æœredisæœ‰ï¼Œè¯»å–éœ€è¦æ¨èçš„æ–‡ç« æ•°é‡æ”¾å›ï¼Œå¹¶åˆ é™¤è¿™äº›æ–‡ç« ï¼Œå¹¶ä¸”æ”¾å…¥æ¨èå†å²æ¨èç»“æœä¸­
    if res:
        cache_client.zrem(key, *res)
    else:
        # - å¦‚æœrediså½“ä¸­ä¸å­˜åœ¨ï¼Œåˆ™ä»wait_recommendä¸­è¯»å–
        # åˆ é™¤redisè¿™ä¸ªé”®
        cache_client.delete(key)
        try:
            # å­—ç¬¦ä¸²ç¼–ç¨‹åˆ—è¡¨
            hbase_cache = eval(hbu.get_table_row('wait_recommend',
                                                'reco:{}'.format(temp.user_id).encode(),
                                                'channel:{}'.format(temp.channel_id).encode()))

        except Exception as e:
            logger.warning(&quot;{} WARN read user_id:{} wait_recommend exception:{} not exist&quot;.format(
                datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, e))

            hbase_cache = []
        if not hbase_cache:
            #   - å¦‚æœwait_recommendä¸­ä¹Ÿæ²¡æœ‰ï¼Œç›´æ¥è¿”å›ç©ºï¼Œå»è¿›è¡Œä¸€æ¬¡å¬å›è¯»å–ã€æ’åºç„¶åæ¨è
            return hbase_cache
        #   - wait_recommendæœ‰ï¼Œä»wait_recommendå–å‡ºæ‰€æœ‰ç»“æœï¼Œå®šä¸€ä¸ªæ•°é‡(å¦‚100ç¯‡)çš„æ–‡ç« å­˜å…¥redis
        if len(hbase_cache) &gt; 100:
            logger.info(
                &quot;{} INFO reduce user_id:{} channel:{} wait_recommend data&quot;.format(
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
            # æ‹¿å‡ºå›ºå®šæ•°é‡ï¼ˆ100ï¼‰ç»™redis
            cache_redis = hbase_cache[:100]
            # æ”¾å…¥redisç¼“å­˜
            cache_client.zadd(key, dict(zip(cache_redis, range(len(cache_redis)))))
            # å‰©ä¸‹çš„æ”¾å›wait hbaseç»“æœ
            hbu.get_table_put('wait_recommend',
                            'reco:{}'.format(temp.user_id).encode(),
                            'channel:{}'.format(temp.channel_id).encode(),
                            str(hbase_cache[100:]).encode())
        else:
            logger.info(
                &quot;{} INFO delete user_id:{} channel:{} wait_recommend data&quot;.format(
                    datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
            # - wait_recommendä¸å¤Ÿä¸€å®šæ•°é‡ï¼Œå…¨éƒ¨å–å‡ºæ”¾å…¥rediså½“ä¸­ï¼Œç›´æ¥æ¨èå‡ºå»
            # æ¸…ç©ºwait_recommend
            hbu.get_table_put('wait_recommend',
                            'reco:{}'.format(temp.user_id).encode(),
                            'channel:{}'.format(temp.channel_id).encode(),
                            str([]).encode())

            # æ”¾å…¥redisç¼“å­˜
            cache_client.zadd(key, dict(zip(hbase_cache, range(len(hbase_cache)))))

        res = cache_client.zrevrange(key, 0, temp.article_num - 1)
        if res:
            cache_client.zrem(key, *res)

    # è¿›è¡Œæ‰§è¡ŒPLï¼Œç„¶åå†™å…¥å†å²æ¨èç»“æœ
    # è¿›è¡Œç±»å‹è½¬æ¢
    res = list(map(int, res))
    logger.info(&quot;{} INFO get cache data and store user_id:{} channel:{} cache history data&quot;.format(
        datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

    # æ”¾å…¥å†å²è®°å½•
    hbu.get_table_put('history_recommend',
                    'reco:his:{}'.format(temp.user_id).encode(),
                    'channel:{}'.format(temp.channel_id).encode(),
                    str(res).encode(),
                    timestamp=temp.time_stamp)

    return res
</code></pre>
<h2 id="åœ¨æ¨èä¸­å¿ƒåŠ å…¥ç¼“å­˜é€»è¾‘">åœ¨æ¨èä¸­å¿ƒåŠ å…¥ç¼“å­˜é€»è¾‘</h2>
<pre><code>from server import redis_cache
# 1ã€è·å–ç¼“å­˜
res = redis_cache.get_reco_from_cache(temp, self.hbu)

# å¦‚æœæ²¡æœ‰ï¼Œç„¶åèµ°ä¸€éç®—æ³•æ¨è å¬å›+æ’åºï¼ŒåŒæ—¶å†™å…¥åˆ°hbaseå¾…æ¨èç»“æœåˆ—è¡¨
if not res:
    logger.info(&quot;{} INFO get user_id:{} channel:{} recall/sort data&quot;.
                format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))

    res = self.user_reco_list(temp)
</code></pre>
<h1 id="æ’åºæ¨¡å‹åœ¨çº¿é¢„æµ‹">æ’åºæ¨¡å‹åœ¨çº¿é¢„æµ‹</h1>
<h2 id="å‰æ–‡">å‰æ–‡</h2>
<pre><code>ä¹‹å‰åœ¨CTRé‚£é‡Œå·²ç»è®­ç»ƒå¥½äº†LRï¼Œå¹¶ä¸”åæ¥ç‰¹å¾ä¸­å¿ƒå·²ç»æŠŠ ç”¨æˆ·å’ŒItemç‰¹å¾æŠ½å–å‡ºæ”¾åˆ°äº†hbase
</code></pre>
<h2 id="æ¥ä¸‹æ¥çš„æ­¥éª¤">æ¥ä¸‹æ¥çš„æ­¥éª¤</h2>
<ul>
<li>å¬å›ä¹‹åçš„æ–‡ç« ç»“æœè¿›è¡Œæ’åº</li>
<li>æ­¥éª¤ï¼š
<ul>
<li>è¯»å–ç”¨æˆ·ç‰¹å¾ä¸­å¿ƒç‰¹å¾</li>
<li>è¯»å–æ–‡ç« ç‰¹å¾ä¸­å¿ƒç‰¹å¾ã€åˆå¹¶ç”¨æˆ·æ–‡ç« ç‰¹å¾æ„é€ é¢„æµ‹æ ·æœ¬</li>
<li>é¢„æµ‹å¹¶è¿›è¡Œæ’åºæ˜¯ç­›é€‰</li>
</ul>
</li>
</ul>
<p>é…ç½®Sparkç¯å¢ƒä»£ç ï¼š</p>
<pre><code>import os
import sys
# å¦‚æœå½“å‰ä»£ç æ–‡ä»¶è¿è¡Œæµ‹è¯•éœ€è¦åŠ å…¥ä¿®æ”¹è·¯å¾„ï¼Œé¿å…å‡ºç°åå¯¼åŒ…é—®é¢˜
BASE_DIR = os.path.dirname(os.path.dirname(os.getcwd()))
sys.path.insert(0, os.path.join(BASE_DIR))

PYSPARK_PYTHON = &quot;/miniconda2/envs/reco_sys/bin/python&quot;
os.environ[&quot;PYSPARK_PYTHON&quot;] = PYSPARK_PYTHON
os.environ[&quot;PYSPARK_DRIVER_PYTHON&quot;] = PYSPARK_PYTHON
from pyspark import SparkConf
from pyspark.sql import SparkSession
from server.utils import HBaseUtils
from server import pool
from pyspark.ml.linalg import DenseVector
from pyspark.ml.classification import LogisticRegressionModel
import pandas as pd


conf = SparkConf()
config = (
    (&quot;spark.app.name&quot;, &quot;sort&quot;),
    (&quot;spark.executor.memory&quot;, &quot;2g&quot;),    # è®¾ç½®è¯¥appå¯åŠ¨æ—¶å ç”¨çš„å†…å­˜ç”¨é‡ï¼Œé»˜è®¤1g
    (&quot;spark.master&quot;, 'yarn'),
    (&quot;spark.executor.cores&quot;, &quot;2&quot;),   # è®¾ç½®spark executorä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°
)

conf.setAll(config)
spark = SparkSession.builder.config(conf=conf).getOrCreate()
</code></pre>
<p>è¯»å–ç”¨æˆ·ç‰¹å¾ä¸­å¿ƒ(10ä¸ª)ï¼ˆç”¨æˆ·ç‰¹å¾æƒé‡ï¼š weights ï¼‰</p>
<pre><code>hbu = HBaseUtils(pool)
# æ’åº
# 1ã€è¯»å–ç”¨æˆ·ç‰¹å¾ä¸­å¿ƒç‰¹å¾
try:
    user_feature = eval(hbu.get_table_row('ctr_feature_user',
                                            '{}'.format(1115629498121846784).encode(),
                                            'channel:{}'.format(18).encode()))
except Exception as e:
    user_feature = []
</code></pre>
<p>è¯»å–æ–‡ç« ç‰¹å¾ä¸­å¿ƒ111ä¸ªï¼š</p>
<pre><code>if user_feature:
    # 2ã€è¯»å–æ–‡ç« ç‰¹å¾ä¸­å¿ƒç‰¹å¾  
    # å½“åˆå­˜çš„æ—¶å€™æ˜¯è¿™æ ·çš„å­˜å‚¨æ ¼å¼ï¼ˆ ä¸€å…±111ä¸ªï¼‰ï¼š
        # channel_id: 1ä¸ªç‰¹å¾             article_feature[0]
        # article_weights: 10ä¸ªç‰¹å¾     article_feature[1:11]
        # articlevector: 100ä¸ªç‰¹å¾       article_feature[11:]
        

    result = []

    for article_id in [17749, 17748, 44371, 44368]:
        try:
            article_feature = eval(hbu.get_table_row('ctr_feature_article',
                                                    '{}'.format(article_id).encode(),
                                                    'article:{}'.format(article_id).encode()))
        except Exception as e:
            article_feature = [0.0] * 111
        f = []
        # ç¬¬ä¸€ä¸ªchannel_id
        f.extend([article_feature[0]])
        # ç¬¬äºŒä¸ªarticle_vector
        f.extend(article_feature[11:])
        # ç¬¬ä¸‰ä¸ªç”¨æˆ·æƒé‡ç‰¹å¾
        f.extend(user_feature)
        # ç¬¬å››ä¸ªæ–‡ç« æƒé‡ç‰¹å¾
        f.extend(article_feature[1:11])
        vector = DenseVector(f)

        result.append([1115629498121846784, article_id, vector])
</code></pre>
<p>æ–‡ç« ç‰¹å¾è¡¨110ä¸ªï¼Œåˆå¹¶åğŸ‘‡</p>
<pre><code>(åˆå¹¶ç‰¹å¾å‘é‡(channel_id1ä¸ª+æ–‡ç« å‘é‡100ä¸ª+ç”¨æˆ·ç‰¹å¾æƒé‡10ä¸ª+æ–‡ç« å…³é”®è¯æƒé‡) = 121ä¸ªç‰¹å¾)
</code></pre>
<h3 id="æœ€ç»ˆç»“æœresultæ ¼å¼">æœ€ç»ˆç»“æœresultæ ¼å¼</h3>
<pre><code>[
    [
            article_id,
            user_id
            DenseVector([channel_id, weights, article_weights])
    ],
    [
            article_id,
            user_id
            DenseVector([channel_id, weights, article_weights])
    ]
]
</code></pre>
<h2 id="å¤„ç†æ ·æœ¬æ ¼å¼æ¨¡å‹åŠ è½½é¢„æµ‹">å¤„ç†æ ·æœ¬æ ¼å¼ï¼Œæ¨¡å‹åŠ è½½é¢„æµ‹</h2>
<pre><code># 4ã€é¢„æµ‹å¹¶è¿›è¡Œæ’åºæ˜¯ç­›é€‰
df = pd.DataFrame(result, columns=[&quot;user_id&quot;, &quot;article_id&quot;, &quot;features&quot;])
test = spark.createDataFrame(df)

# åŠ è½½é€»è¾‘å›å½’æ¨¡å‹
model = LogisticRegressionModel.load(&quot;hdfs://hadoop-master:9000/headlines/models/LR.obj&quot;)
predict = model.transform(test)
</code></pre>
<p>é¢„æµ‹ç»“æœè¿›è¡Œç­›é€‰</p>
<pre><code>def vector_to_double(row):
    return float(row.article_id), float(row.probability[1])
res = predict.select(['article_id', 'probability']).rdd.map(vector_to_double).toDF(['article_id', 'probability']).sort('probability', ascending=False)
</code></pre>
<p>è·å–æ’åºä¹‹åå‰Nä¸ªæ–‡ç« </p>
<pre><code>article_list = [i.article_id for i in res.collect()]
if len(article_list) &gt; 100:
    article_list = article_list[:100]
reco_set = list(map(int, article_list))
</code></pre>
<h1 id="æ·»åŠ å®æ—¶æ’åºçš„æ¨¡å‹é¢„æµ‹">æ·»åŠ å®æ—¶æ’åºçš„æ¨¡å‹é¢„æµ‹</h1>
<p>æ·»åŠ sparké…ç½®ï¼Œgrpcå¯åŠ¨ç°å°†sparkç›¸å…³ä¿¡æ¯åˆå§‹åŒ–</p>
<pre><code>from pyspark import SparkConf
from pyspark.sql import SparkSession
# sparké…ç½®
conf = SparkConf()
conf.setAll(DefaultConfig.SPARK_GRPC_CONFIG)

SORT_SPARK = SparkSession.builder.config(conf=conf).getOrCreate()

# SPARK grpcé…ç½®
SPARK_GRPC_CONFIG = (
(&quot;spark.app.name&quot;, &quot;grpcSort&quot;),  # è®¾ç½®å¯åŠ¨çš„sparkçš„appåç§°ï¼Œæ²¡æœ‰æä¾›ï¼Œå°†éšæœºäº§ç”Ÿä¸€ä¸ªåç§°
(&quot;spark.master&quot;, &quot;yarn&quot;),
(&quot;spark.executor.instances&quot;, 4)
)
</code></pre>
<p>æ·»åŠ æ¨¡å‹æœåŠ¡é¢„æµ‹æ¨¡å—ï¼Œsort_service, å¢åŠ ä»¥ä¸‹é¢„æµ‹é€»è¾‘</p>
<pre><code>from server import SORT_SPARK
from pyspark.ml.linalg import DenseVector
from pyspark.ml.classification import LogisticRegressionModel
import pandas as pd
import numpy as np
from datetime import datetime
import logging

logger = logging.getLogger(&quot;recommend&quot;)
</code></pre>
<p>é¢„æµ‹å‡½æ•°</p>
<pre><code>def lr_sort_service(reco_set, temp, hbu):
    &quot;&quot;&quot;
    æ’åºè¿”å›æ¨èæ–‡ç« 
    :param reco_set:å¬å›åˆå¹¶è¿‡æ»¤åçš„ç»“æœ
    :param temp: å‚æ•°
    :param hbu: Hbaseå·¥å…·
    :return:
    &quot;&quot;&quot;
    # æ’åº
    # 1ã€è¯»å–ç”¨æˆ·ç‰¹å¾ä¸­å¿ƒç‰¹å¾
    try:
        user_feature = eval(hbu.get_table_row('ctr_feature_user',
                                            '{}'.format(temp.user_id).encode(),
                                            'channel:{}'.format(temp.channel_id).encode()))
        logger.info(&quot;{} INFO get user user_id:{} channel:{} profile data&quot;.format(
            datetime.now().strftime('%Y-%m-%d %H:%M:%S'), temp.user_id, temp.channel_id))
    except Exception as e:
        user_feature = []

    if user_feature:
        # 2ã€è¯»å–æ–‡ç« ç‰¹å¾ä¸­å¿ƒç‰¹å¾
        result = []

        for article_id in reco_set:
            try:
                article_feature = eval(hbu.get_table_row('ctr_feature_article',
                                                        '{}'.format(article_id).encode(),
                                                        'article:{}'.format(article_id).encode()))
            except Exception as e:

                article_feature = [0.0] * 111
            f = []
            # ç¬¬ä¸€ä¸ªchannel_id
            f.extend([article_feature[0]])
            # ç¬¬äºŒä¸ªarticle_vector
            f.extend(article_feature[11:])
            # ç¬¬ä¸‰ä¸ªç”¨æˆ·æƒé‡ç‰¹å¾
            f.extend(user_feature)
            # ç¬¬å››ä¸ªæ–‡ç« æƒé‡ç‰¹å¾
            f.extend(article_feature[1:11])
            vector = DenseVector(f)
            result.append([temp.user_id, article_id, vector])

        # 4ã€é¢„æµ‹å¹¶è¿›è¡Œæ’åºæ˜¯ç­›é€‰
        df = pd.DataFrame(result, columns=[&quot;user_id&quot;, &quot;article_id&quot;, &quot;features&quot;])
        test = SORT_SPARK.createDataFrame(df)

        # åŠ è½½é€»è¾‘å›å½’æ¨¡å‹
        model = LogisticRegressionModel.load(&quot;hdfs://hadoop-master:9000/headlines/models/LR.obj&quot;)
        predict = model.transform(test)

        def vector_to_double(row):
            return float(row.article_id), float(row.probability[1])

        res = predict.select(['article_id', 'probability']).rdd.map(vector_to_double).toDF(
            ['article_id', 'probability']).sort('probability', ascending=False)
        article_list = [i.article_id for i in res.collect()]
        logger.info(&quot;{} INFO sorting user_id:{} recommend article&quot;.format(datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                                                                        temp.user_id))
        # æ’åºåï¼Œåªå°†æ’ååœ¨å‰100ä¸ªæ–‡ç« IDè¿”å›ç»™ç”¨æˆ·æ¨è
        if len(article_list) &gt; 100:
            article_list = article_list[:100]
        reco_set = list(map(int, article_list))

    return reco_set
</code></pre>
<p>æ¨èä¸­å¿ƒåŠ å…¥æ’åº</p>
<pre><code># é…ç½®default
RAParam = param(
    COMBINE={
        'Algo-1': (1, [100, 101, 102, 103, 104], [200]),  # é¦–é¡µæ¨èï¼Œæ‰€æœ‰å¬å›ç»“æœè¯»å–+LRæ’åº
        'Algo-2': (2, [100, 101, 102, 103, 104], [200])  # é¦–é¡µæ¨èï¼Œæ‰€æœ‰å¬å›ç»“æœè¯»å– æ’åº
    },

# reco_center
from server.sort_service import lr_sort_service
sort_dict = {
    'LR': lr_sort_service,
}

# æ’åºä»£ç é€»è¾‘
_sort_num = RAParam.COMBINE[temp.algo][2][0]
reco_set = sort_dict[RAParam.SORT[_sort_num]](reco_set, temp, self.hbu)
</code></pre>
<p>ä¸ºäº†æµ‹è¯•,åŸæ¥çš„æ•°æ®é‡æ–°æ’å…¥ä¸€ä»½ï¼Œå†å²è®°å½•ä¹Ÿåˆ é™¤æ‰ï¼Œç¼“å­˜ä¹Ÿåˆ æ‰ï¼Œ</p>
<pre><code>hbase(main):016:0* put 'cb_recall', 'recall:user:1115629498121846784', 'als:18', [19200, 17665, 16151, 16411, 19233, 13090,15140, 16421, 19494, 14381, 17966, 17454, 14125, 16174, 14899, 44339, 16437, 18743, 44090, 18238, 13890, 14915, 15429, 15944, 44371, 18005, 15196, 13410, 13672, 44137, 18795, 19052, 44652, 44654, 44657, 14961, 17522, 43894, 44412, 16000, 14208, 44419, 17802, 14223, 18836, 140956, 18335, 13728, 14498, 44451, 44456, 18609, 18353, 44468, 18103, 135869, 16062, 14015, 13757, 13249, 44483, 17605, 14021, 15309, 18127, 43983, 44754, 43986, 19413, 14805, 18904, 44761, 17114, 13272, 14810, 18907, 13022, 14299, 17120, 17632, 43997, 17889, 17385, 18156, 15085, 13295, 44020, 14839, 44024, 14585, 18172, 44541]
Took 0.2007 seconds                                                                                 
hbase(main):017:0&gt; get 'cb_recall', 'recall:user:1115629498121846784'
COLUMN                     CELL                                                                      als:13                    timestamp=1558041571134, value=[141431]                                   als:18                    timestamp=1559205376286, value=[19200, 17665, 16151, 16411, 19233, 13090,                            15140, 16421, 19494, 14381, 17966, 17454, 14125, 16174, 14899, 44339, 16                           437, 18743, 44090, 18238, 13890, 14915, 15429, 15944, 44371, 18005, 15196                           , 13410, 13672, 44137, 18795, 19052, 44652, 44654, 44657, 14961, 17522, 4                           3894, 44412, 16000, 14208, 44419, 17802, 14223, 18836, 140956, 18335, 137
                        28, 14498, 44451, 44456, 18609, 18353, 44468, 18103, 135869, 16062, 14015
                        , 13757, 13249, 44483, 17605, 14021, 15309, 18127, 43983, 44754, 43986, 1
                        9413, 14805, 18904, 44761, 17114, 13272, 14810, 18907, 13022, 14299, 1712
                        0, 17632, 43997, 17889, 17385, 18156, 15085, 13295, 44020, 14839, 44024, 
                        14585, 18172, 44541]                                                     
als:5                     timestamp=1558041564668, value=[141440]                                  
als:7                     timestamp=1558041564688, value=[141437]                                  
1 row(s)
Took 0.1108 seconds
</code></pre>
<h1 id="supervisoræ·»åŠ grpcå®æ—¶æ¨èç¨‹åº">supervisoræ·»åŠ grpcå®æ—¶æ¨èç¨‹åº</h1>
<pre><code>[program:online]
environment=JAVA_HOME=/root/bigdata/jdk,SPARK_HOME=/root/bigdata/spark,HADOOP_HOME=/root/bigdata/hadoop,PYSPARK_PYTHON=/miniconda2/envs/reco_sys/bin/python ,PYSPARK_DRIVER_PYTHON=/miniconda2/envs/reco_sys/bin/python
command=/miniconda2/envs/reco_sys/bin/python /root/toutiao_project/reco_sys/abtest/routing.py
directory=/root/toutiao_project/reco_sys/abtest
user=root
autorestart=true
redirect_stderr=true
stdout_logfile=/root/logs/recommendsuper.log
loglevel=info
stopsignal=KILL
stopasgroup=true
killasgroup=true
</code></pre>
<p>supervisoræ‰§è¡Œå‘½ä»¤ update,å¼€å¯å®æ—¶æ’åºæµ‹è¯•ã€‚</p>

                </div>
                <div class="clear"></div>
              </section>
            </article>
            <div class="clear"></div>

            <section class="related section">
              
              <article class="prev grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://cythonlin.github.io/media/images/EjFvvnhFs.jpg');"></div>
                 <a href="https://cythonlin.github.io/post/rs-greater-fu-xi/" class="full-link"></a>
                 <div class="info">
                  <time datetime="2021-02-28">2021-02-28</time>
                  <h4 class="title white no-margin">RS =&gt; æ¨èç³»ç»Ÿï¼ˆä¸ƒï¼‰DL-Wide&amp;Deep</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://cythonlin.github.io/media/images/left-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              
              
              <article class="next grid-50 tablet-grid-50 grid-parent">
                <div class="thumb cover lazy loaded" style="background-image: url('https://cythonlin.github.io/media/images/EjFvvnhFs.jpg');"></div>
                 <a href="https://cythonlin.github.io/post/ide-greater-cheatsh/" class="full-link"></a>
                 <div class="info">
                  <time datetime="2021-02-22">2021-02-22</time>
                  <h4 class="title white no-margin">RS =&gt; æ¨èç³»ç»Ÿï¼ˆäº”ï¼‰å®æ—¶æ¨è+ABTest+æ¨èä¸­å¿ƒ</h4>
                </div>
                 <span class="epcl-button red">
                  <img src="https://cythonlin.github.io/media/images/right-arrow.svg" width="15" alt="Left Arrow">
                </span>
                <div class="overlay"></div>
              </article>
              

                <div class="clear"></div>
            </section>

              <div class="clear"></div>
              
            
<!--               <div id="comments" class="bg-white hosted ">
                <p>è¯·åˆ°å®¢æˆ·ç«¯â€œä¸»é¢˜--è‡ªå®šä¹‰é…ç½®--valineâ€ä¸­å¡«å…¥IDå’ŒKEY</p>
              </div> -->
              <div class="clear"></div>
            

            </div>
          </div>
      </main>

          <footer id="footer" class="grid-container">
        <div class="widgets row gradient-effect">
            <div class="default-sidebar border-effect">
              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_epcl_posts_thumbs underline-effect">
                  <h4 class="widget-title title white bordered">æœ€æ–°æ–‡ç« </h4>
                  
                  
                  <article class="item post-0 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://cythonlin.github.io/post/ide-greater-my-sublimepy/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('/media/images/gridea.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2021-03-03">2021-03-03</time>
                      <h4 class="title usmall">
                        <a href="https://cythonlin.github.io/post/ide-greater-my-sublimepy/">IDE =&gt; My Sublimeï¼ˆPYï¼‰</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-1 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://cythonlin.github.io/post/rs-greater-9/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('/media/images/gridea.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2021-03-03">2021-03-03</time>
                      <h4 class="title usmall">
                        <a href="https://cythonlin.github.io/post/rs-greater-9/"> IDE =&gt; My Pycharm</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  <article class="item post-2 post type-post status-publish format-standard has-post-thumbnail hentry">
                    <a href="https://cythonlin.github.io/post/rs-greater-8/" class="thumb hover-effect">
                      <span class="fullimage cover" style="display:block;border-radius:50%;background-image: url('/media/images/gridea.jpg');"></span>
                    </a>
                    <div class="info gradient-effect">
                      <time datetime="2021-03-03">2021-03-03</time>
                      <h4 class="title usmall">
                        <a href="https://cythonlin.github.io/post/rs-greater-8/">GO =&gt; GolangæŒç»­...</a>
                      </h4>
                    </div>
                    <div class="clear"></div>
                  </article>
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="tag_cloud-2" class="widget widget_tag_cloud underline-effect">
                  <h4 class="widget-title title white bordered">æ ‡ç­¾äº‘</h4>
                  <div class="tagcloud">
                    
                      <a href="https://cythonlin.github.io/tag/c137hZpK4/" class="ctag ctag-0 ctag-c137hZpK4" aria-label="">IDE</a>
                    
                      <a href="https://cythonlin.github.io/tag/wAXYBHxvH/" class="ctag ctag-1 ctag-wAXYBHxvH" aria-label="">Python</a>
                    
                      <a href="https://cythonlin.github.io/tag/XH05Gb5J6/" class="ctag ctag-2 ctag-XH05Gb5J6" aria-label="">Golang</a>
                    
                      <a href="https://cythonlin.github.io/tag/EjFvvnhFs/" class="ctag ctag-3 ctag-EjFvvnhFs" aria-label="">RS</a>
                    
                      <a href="https://cythonlin.github.io/tag/sKPdrpV6Y/" class="ctag ctag-4 ctag-sKPdrpV6Y" aria-label="">PR</a>
                    
                      <a href="https://cythonlin.github.io/tag/1L4lr0i2f/" class="ctag ctag-5 ctag-1L4lr0i2f" aria-label="">Docker</a>
                    
                      <a href="https://cythonlin.github.io/tag/n16me-6oV/" class="ctag ctag-6 ctag-n16me-6oV" aria-label="">AI</a>
                    
                      <a href="https://cythonlin.github.io/tag/FLS_eF6Eg/" class="ctag ctag-7 ctag-FLS_eF6Eg" aria-label="">KG</a>
                    
                      <a href="https://cythonlin.github.io/tag/sJAb6NuUK/" class="ctag ctag-8 ctag-sJAb6NuUK" aria-label="">DB</a>
                    
                  </div>
                  <div class="clear"></div>
                </section>
              </div>

              <div class="grid-33 tablet-grid-50 mobile-grid-100">
                <section id="epcl_about-2" class="widget widget_epcl_about underline-effect">
                  <h4 class="widget-title title white bordered">å…³äºæˆ‘</h4>
                  <div class="avatar">
                    <a href="" class="translate-effect thumb"><span class="fullimage cover" style="background-image: url(https://cythonlin.github.io/images/avatar.png);"></span></a>
                  </div>
                  <div class="info">
                    <h4 class="title small author-name gradient-effect no-margin"><a href="">Cython_lin</a></h4>
                    <p class="founder"></p>
                    <div class="social">
                      
                        
                      
                        
                      
                        
                      
                        
                      
                        
                      
                    </div> 
                  </div>
                  <div class="clear"></div>
                  </section>
              </div>

            </div>
            <div class="clear"></div>
        </div>

        <div class="logo">
          <a href="https://cythonlin.github.io"><img src="\media\images\custom-footerLogo.png" alt=""></a>
        </div>
        <p class="published border-effect">
          Â©2019 å…± 78 ç¯‡æ–‡ç« 
          <br/>

        </p>
        
        <a href="javascript:void(0)" id="back-to-top" class="epcl-button dark" style="display:none">
          <i class="fa fa-arrow"></i>
        </a>
    </footer>
    
    <div class="clear"></div>

        

      
    <script src="https://cythonlin.github.io/media/js/functions-post.js"></script>

    </div>
    <!-- end: #wrapper -->
  </body>
</html>
